From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 1FAE0208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:16 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727274AbeHHQLA (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:00 -0400
Received: from mail-ed1-f67.google.com ([209.85.208.67]:47050 "EHLO
        mail-ed1-f67.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727251AbeHHQLA (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:00 -0400
Received: by mail-ed1-f67.google.com with SMTP id o8-v6so1274047edt.13
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:13 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=NRwUxYF0OT/c+4KUQieDDAx3+4pbyqoI43a7cReqxYU=;
        b=OGEdeNm63L0btwXrzuz/LBkYmlI4JQChMUJHALpUKzD+dc2uV0aTZOuHOXY4gMpoNn
         KnuyoBI9sqpbr1btLAeblIRanyTuMJTXb7Y+bfx/Inb5QwJBMLqU2MlXiJkIbyv4IyM/
         b82kkr9aO9q1nJM4pfG+NuUA66CJgj4/6go5zQr1RM6x+fIyO+020aETYb0p1Quhoc1V
         s0daAE1E2CVNQ20fp77D/14rPTZPbeprLbvL5tbhKHwKnRXD8rR/fC9u/6bpFFc+w1MA
         Tnn5ICUJqjWtBqPSZWAHR4966vbscZBnvorcozlT452EXwbjZvZP0DNl0CLfqAx9uxKB
         2lYA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=NRwUxYF0OT/c+4KUQieDDAx3+4pbyqoI43a7cReqxYU=;
        b=QepEoa8f8O8eNowy1bq3+Q0CDCvxg1Q3EQDdB7HSZsfsDFa8oWsxTNUM6PYQEIOOcr
         VWX6lhtOeyqcUZO19l8AsOL5JVqYNTgjXvTp1zK14QU2u/m4hP3oUKGVPzwl02QdJhsD
         DpboveBzZaNmuzgsftbbOarfWY2d/fc5pxGmNIKLmthrYR28utLOg6WGYAKy0d/XbPkP
         tNaJ9rzMtyebbYXKwyx31ryl2QqY4HlY4phc8KmJ8AysQW6vaM2qUpgAzAWhD4E1insI
         LHcPNmoMsMCZ6lOl06J+FkPaMe8FPOxbdQeBfh0Dkw9FTXKXaD4NoQwh/CzNVMOX/MXC
         H8HA==
X-Gm-Message-State: AOUpUlHnlvZb3Nl4vD+7leNmRSS37FU0ac4tGSqLDTDcZEr/AvafkDH7
        7gECGaS8Ofka5Xu4Kd2Q/gJarszb
X-Google-Smtp-Source: AA+uWPzH9fVy9D0bUPlSCS9gAvGRZ6nU/kw7fcBEFbLv0Myyk1L+xIAz+i4Y/lQVXiZgrTkoXUvejw==
X-Received: by 2002:a50:b642:: with SMTP id c2-v6mr3357672ede.288.1533736272986;
        Wed, 08 Aug 2018 06:51:12 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.09
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:12 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 01/11] builtin rebase: support --onto
Date:   Wed,  8 Aug 2018 19:33:20 +0545
Message-Id: <20180808134830.19949-2-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-2-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

The `--onto` option is important, as it allows to rebase a range of
commits onto a different base commit (which gave the command its odd
name: "rebase").

This commit introduces options parsing so that different options can
be added in future commits.

Note: As this commit introduces to the parse_options() call (which
"eats" argv[0]), the argc is now expected to be lower by one after this
patch, compared to before this patch: argv[0] no longer refers to the
command name, but to the first (non-option) command-line parameter.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 35 ++++++++++++++++++++++++++++++-----
 1 file changed, 30 insertions(+), 5 deletions(-)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index e695d8a430..742ed31498 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -16,6 +16,16 @@
 #include "cache-tree.h"
 #include "unpack-trees.h"
 #include "lockfile.h"
+#include "parse-options.h"
+
+static char const * const builtin_rebase_usage[] = {
+	N_("git rebase [-i] [options] [--exec <cmd>] [--onto <newbase>] "
+		"[<upstream>] [<branch>]"),
+	N_("git rebase [-i] [options] [--exec <cmd>] [--onto <newbase>] "
+		"--root [<branch>]"),
+	N_("git rebase --continue | --abort | --skip | --edit-todo"),
+	NULL
+};
 
 static GIT_PATH_FUNC(apply_dir, "rebase-apply")
 static GIT_PATH_FUNC(merge_dir, "rebase-merge")
@@ -301,6 +311,12 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	int ret, flags;
 	struct strbuf msg = STRBUF_INIT;
 	struct strbuf revisions = STRBUF_INIT;
+	struct option builtin_rebase_options[] = {
+		OPT_STRING(0, "onto", &options.onto_name,
+			   N_("revision"),
+			   N_("rebase onto given branch instead of upstream")),
+		OPT_END(),
+	};
 
 	/*
 	 * NEEDSWORK: Once the builtin rebase has been tested enough
@@ -318,13 +334,22 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			BUG("sane_execvp() returned???");
 	}
 
-	if (argc != 2)
-		die(_("Usage: %s <base>"), argv[0]);
+	if (argc == 2 && !strcmp(argv[1], "-h"))
+		usage_with_options(builtin_rebase_usage,
+				   builtin_rebase_options);
+
 	prefix = setup_git_directory();
 	trace_repo_setup(prefix);
 	setup_work_tree();
 
 	git_config(git_default_config, NULL);
+	argc = parse_options(argc, argv, prefix,
+			     builtin_rebase_options,
+			     builtin_rebase_usage, 0);
+
+	if (argc > 2)
+		usage_with_options(builtin_rebase_usage,
+				   builtin_rebase_options);
 
 	switch (options.type) {
 	case REBASE_MERGE:
@@ -343,10 +368,10 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	}
 
 	if (!options.root) {
-		if (argc < 2)
+		if (argc < 1)
 			die("TODO: handle @{upstream}");
 		else {
-			options.upstream_name = argv[1];
+			options.upstream_name = argv[0];
 			argc--;
 			argv++;
 			if (!strcmp(options.upstream_name, "-"))
@@ -377,7 +402,7 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	 * orig_head -- commit object name of tip of the branch before rebasing
 	 * head_name -- refs/heads/<that-branch> or "detached HEAD"
 	 */
-	if (argc > 1)
+	if (argc > 0)
 		 die("TODO: handle switch_to");
 	else {
 		/* Do not need to switch branches, we are already on it. */
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id A08C8208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:19 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727330AbeHHQLE (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:04 -0400
Received: from mail-ed1-f65.google.com ([209.85.208.65]:44316 "EHLO
        mail-ed1-f65.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727251AbeHHQLD (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:03 -0400
Received: by mail-ed1-f65.google.com with SMTP id f23-v6so1278051edr.11
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:17 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=sdGIkFhKgQ7CW3+0cianDC0ePmyMRxEpcRzI+AnUidQ=;
        b=Kwmxv/YxsQJxBS/5Os6XjOiNx7TDTwXDQMM8ue8g7Z4Wj1vZdSlOcaJMgzqu/8me7i
         wCN6nTeDmTDTETZk1IAOXd1k5qegg7kYwXdZAeHR/h3C8cVYukrqUE2VbuSeYvBQGKbm
         bBjlYHJiw4b9gsGHozBzybGFP08qRN6mi7jDW3F/wArGt74lyOgwBz9CEnkg4Tokcvmm
         Oja5oBrDDVQ1Xjl07/XnoBRiHnXVA4mSdr0bj43Vy7smXbhmJM2dWnqmzBDdYRawUPe7
         BtMK76gqrjvnCIqzxa0mhHeN6fBc72LCRhYfBlIC5xmJS88bXH3K2rUj/XVZo7HUvM6o
         VmgA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=sdGIkFhKgQ7CW3+0cianDC0ePmyMRxEpcRzI+AnUidQ=;
        b=VpTbhmeg3r6mZd6wm6I62pb/7GCPovuNaQKiJmAl86k+Kjx5iqmPaD7UPEt5E6uo0l
         a0mSH2tXZvF4TPx3cdqbIgOpLRFngmPShoLivP2krT4F1F+aDyp4/T2t556SvKR0rkz+
         uaXroVdQrXIHEjg13QXkJWEwA2cL/LEtDxPJg5AIyXOMpcVSi9JHyiF3K7ErIYslIpSL
         3YZgduS7R81OXPrdqjNMfvlZ0PGXIfRjQuf0fzgnQIWY3Gh3Kv1Lc/Xwf6SwsO1EmOup
         XxnTuSm6MuDbuSeNMqocVvxQXLnn2qYkM7SjhtZgtvx+RL4PYNemrl7jCGkOw/KFznt1
         WHuQ==
X-Gm-Message-State: AOUpUlHuCjZwpK0BpGf7FCKrZahCHJuEh4Zzv4ZIEb7BfAx8JVlzfgWh
        JPa46U1D14FF+DdaMUrLFM8QPI6g
X-Google-Smtp-Source: AA+uWPyisLB8FGm5xSL+ZFwVsr6AuRqE40pdBkEqiDV7mZ35wz4qQjXk6o2ZPKeOXMr3eL8O/RxaLQ==
X-Received: by 2002:a50:b822:: with SMTP id j31-v6mr3319146ede.76.1533736276648;
        Wed, 08 Aug 2018 06:51:16 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.13
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:15 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 02/11] builtin rebase: support `git rebase --onto A...B`
Date:   Wed,  8 Aug 2018 19:33:21 +0545
Message-Id: <20180808134830.19949-3-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-3-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit implements support for an --onto argument that is actually a
"symmetric range" i.e. `<rev1>...<rev2>`.

The equivalent shell script version of the code offers two different
error messages for the cases where there is no merge base vs more than
one merge base. Though following the similar approach would be nice,
this would create more complexity than it is of current. Currently, for
simple convenience, the `get_oid_mb()` function is used whose return
value does not discern between those two error conditions.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 742ed31498..38c496dd10 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -17,6 +17,7 @@
 #include "unpack-trees.h"
 #include "lockfile.h"
 #include "parse-options.h"
+#include "commit.h"
 
 static char const * const builtin_rebase_usage[] = {
 	N_("git rebase [-i] [options] [--exec <cmd>] [--onto <newbase>] "
@@ -311,6 +312,7 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	int ret, flags;
 	struct strbuf msg = STRBUF_INIT;
 	struct strbuf revisions = STRBUF_INIT;
+	struct object_id merge_base;
 	struct option builtin_rebase_options[] = {
 		OPT_STRING(0, "onto", &options.onto_name,
 			   N_("revision"),
@@ -387,7 +389,11 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	if (!options.onto_name)
 		options.onto_name = options.upstream_name;
 	if (strstr(options.onto_name, "...")) {
-		die("TODO");
+		if (get_oid_mb(options.onto_name, &merge_base) < 0)
+			die(_("'%s': need exactly one merge base"),
+			    options.onto_name);
+		options.onto = lookup_commit_or_die(&merge_base,
+						    options.onto_name);
 	} else {
 		options.onto = peel_committish(options.onto_name);
 		if (!options.onto)
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 52421208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:23 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727335AbeHHQLH (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:07 -0400
Received: from mail-ed1-f67.google.com ([209.85.208.67]:37746 "EHLO
        mail-ed1-f67.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727251AbeHHQLH (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:07 -0400
Received: by mail-ed1-f67.google.com with SMTP id b10-v6so1306364eds.4
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:21 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=1wa5vq/PaNnWj+S1jofJ/Vs1rg8E3NrlYrMIdE/K4IA=;
        b=hfIKroB7u0PK1QZsNlnTS8sWTWeT9STaI+Hkr35FUVSpFjaCUOxOc33+Bsa0aW2OZ7
         s8eXH/QJLyjayQHvIc9nsQHh9ZWzS2MQg+izCVIwOOsR/K0XPxjiFVKtyGfUbjreOXbt
         S1t6sEeYlOS7WcjvQtReyc55vzldN8yVeEnypOLiTqrq0p4M76XP9/rWOJkkF7kBGh82
         o5PdVldKMoaeWGYxPWaHiQS3lqB0wgRmufVFvVlQqyyoph3CvgVye4V9EFp8Vv9YBG96
         ZuUc1lXMd4AnXb/Z7YM3lgwUkaDwC5UISvoSrjv1OuqoMgFPabpxlWZlr8TYrS0tlLjb
         R1sg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=1wa5vq/PaNnWj+S1jofJ/Vs1rg8E3NrlYrMIdE/K4IA=;
        b=Fewbriwu0ttvCDoAl9+v3ziFEx5tpjFtUW0WgZzmwKe/NB5YQuIJM890dutSXK+pgw
         VJgJkhQdlk8wXMlQdd20aJ5nQzq4Fi584ehT9A1w0dKt4cVwCUoxJgCb2nmNL28p1Yl4
         XPFFENpHnlkU1m80zleeaSATKQYPcWRfsi5x+gOzBbhIbi2QKUhz2SZwad7L1lWLZdo9
         CvYLxrQwJgxHQlCgbleFJjYEz3I7Xgq7sr9n+0S4EPFC9jp4uM9TCrt7XWkHBUuqh9jD
         yYAF370NJkc94cdNtzP1w1hmFsu1hPfMIZxWnq4Kft7CF1P6QDGrYfa9ddIlqpIW/2Fr
         8q6Q==
X-Gm-Message-State: AOUpUlHoHvzBDGkDEI4ymQaudgmQuiIpcIZidxUqHpXcKRj4Xx6yLvVI
        /Cc0u88btvUv1pmpHWWtUimOoMi7
X-Google-Smtp-Source: AA+uWPzThRhFyU+o13uCpop36qbyjLMgMKblxxzuEdySWI9WzudcWsDyMFHfR+9k+ZGtlYPIGMyZzA==
X-Received: by 2002:a50:8921:: with SMTP id e30-v6mr3390957ede.213.1533736280282;
        Wed, 08 Aug 2018 06:51:20 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.16
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:19 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 03/11] builtin rebase: handle the pre-rebase hook (and add --no-verify)
Date:   Wed,  8 Aug 2018 19:33:22 +0545
Message-Id: <20180808134830.19949-4-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-4-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit converts the equivalent part of the shell script
`git-legacy-rebase.sh` to run the pre-rebase hook (unless disabled), and
to interrupt the rebase with error if the hook fails.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 38c496dd10..b79f9b0a9f 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -70,6 +70,7 @@ struct rebase_options {
 	const char *state_dir;
 	struct commit *upstream;
 	const char *upstream_name;
+	const char *upstream_arg;
 	char *head_name;
 	struct object_id orig_head;
 	struct commit *onto;
@@ -310,6 +311,7 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	};
 	const char *branch_name;
 	int ret, flags;
+	int ok_to_skip_pre_rebase = 0;
 	struct strbuf msg = STRBUF_INIT;
 	struct strbuf revisions = STRBUF_INIT;
 	struct object_id merge_base;
@@ -317,6 +319,8 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		OPT_STRING(0, "onto", &options.onto_name,
 			   N_("revision"),
 			   N_("rebase onto given branch instead of upstream")),
+		OPT_BOOL(0, "no-verify", &ok_to_skip_pre_rebase,
+			 N_("allow pre-rebase hook to run")),
 		OPT_END(),
 	};
 
@@ -382,6 +386,7 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		options.upstream = peel_committish(options.upstream_name);
 		if (!options.upstream)
 			die(_("invalid upstream '%s'"), options.upstream_name);
+		options.upstream_arg = options.upstream_name;
 	} else
 		die("TODO: upstream for --root");
 
@@ -430,6 +435,12 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			die(_("Could not resolve HEAD to a revision"));
 	}
 
+	/* If a hook exists, give it a chance to interrupt*/
+	if (!ok_to_skip_pre_rebase &&
+	    run_hook_le(NULL, "pre-rebase", options.upstream_arg,
+			argc ? argv[0] : NULL, NULL))
+		die(_("The pre-rebase hook refused to rebase."));
+
 	strbuf_addf(&msg, "rebase: checkout %s", options.onto_name);
 	if (reset_head(&options.onto->object.oid, "checkout", NULL, 1))
 		die(_("Could not detach HEAD"));
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 67B71208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:27 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727340AbeHHQLL (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:11 -0400
Received: from mail-ed1-f67.google.com ([209.85.208.67]:35425 "EHLO
        mail-ed1-f67.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727048AbeHHQLL (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:11 -0400
Received: by mail-ed1-f67.google.com with SMTP id e6-v6so1308567edr.2
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:24 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=SdR1olAKZNZ981DWOat9jkNz15uGDpdIBtJyZe5D3AY=;
        b=KuZmIdE1yGWmGUkQKKdDkHuvI38jzxzyOctY0dJZ3uar0Lo+mwNk7r6KeRMMzfMDCg
         BoDG3vS7FUPVyoatSOpS8LJnTMAgu6hWcC1wp98uvDEh3vqQ5OQqpiHpETRMY7Go9Nwp
         m4OiXt5QWzgCq+8z3RImE9kXeHoI5VnWdpxFwlz61O0/Q9ki9Fo4IhpiMH+iwIku922B
         AJukeZxffUQiDnZ8+iG3C/DBRJGm8DzYuxnLTHbWiBbSAoiYVXkZTJzCrXodScuXk0DT
         kdNzlQdcvjwC+pdYIfq7x/tKCODTD2IQybwDMCcHV8RcVsy0hU1LYCdfv7Xk+DtEP8QM
         JMJg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=SdR1olAKZNZ981DWOat9jkNz15uGDpdIBtJyZe5D3AY=;
        b=XDAztttaGcViL57OK/PSFNTDhkCuF7TdtU9En3l3Bl+n7PDcKYRZavypCCUIa0vcrk
         YVG8gyPl7BHmj9TB0/3IZP13P0MdT5bLZp3C831DHid+GjuirhYjg8xqZbfEaqvzvKJx
         oze+AipoXPZQFOlg+334/0pDbrA7zaLF4kjI2DkHxT0GT+5AJscVa4iFAkE9Szjks5h7
         30bmWnulbJA+Jgt7itwnKgeiy7LwqchMLXihsvqBLi/Hicg3sbYC1Zu2C8qgpDfYNKZv
         B4rfwbU3M2M+pI4sfSbK6dLd0i9Epq3+wwsNuzs+/FBrbdt1x6AthBxWkeMr4obdWGTw
         Clxw==
X-Gm-Message-State: AOUpUlEIRrhM1w2H/R3sg/IIfeb6XNJ4Oba3aNQ5pAl49ipcTjhsXbW4
        41PULm0Yv0RYsMa/ShwMqbJAoJKS
X-Google-Smtp-Source: AA+uWPyIfoZ51lOIQIkCVL0f9iZHwztOfcPiRvvapRLzsnQDMbM8Kql1S7aiSxrMWbpvM9ZcGirCRg==
X-Received: by 2002:a50:af03:: with SMTP id g3-v6mr3307979edd.220.1533736283919;
        Wed, 08 Aug 2018 06:51:23 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.20
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:23 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 04/11] builtin rebase: support --quiet
Date:   Wed,  8 Aug 2018 19:33:23 +0545
Message-Id: <20180808134830.19949-5-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-5-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit introduces a rebase option `--quiet`. While `--quiet` is
commonly perceived as opposite to `--verbose`, this is not the case for
the rebase command: both `--quiet` and `--verbose` default to `false` if
neither `--quiet` nor `--verbose` is present.

This commit goes further and introduces `--no-quiet` which is the
contrary of `--quiet` and it's introduction doesn't modify any
behaviour.

Note: The `flags` field in `rebase_options` will accumulate more bits in
subsequent commits, in particular a verbose and a diffstat flag. And as
--quoet inthe shell scripted version of the rebase command switches off
--verbose and --stat, and as --verbose switches off --quiet, we use the
(negated) REBASE_NO_QUIET instead of REBASE_QUIET: this allows us to
turn off the quiet mode and turn on the verbose and diffstat mode in a
single OPT_BIT(), and the opposite in a single OPT_NEGBIT().

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index b79f9b0a9f..19fa4d3fc4 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -79,6 +79,10 @@ struct rebase_options {
 	int root;
 	struct commit *restrict_revision;
 	int dont_finish_rebase;
+	enum {
+		REBASE_NO_QUIET = 1<<0,
+	} flags;
+	struct strbuf git_am_opt;
 };
 
 /* Returns the filename prefixed by the state_dir */
@@ -159,6 +163,9 @@ static int run_specific_rebase(struct rebase_options *opts)
 	add_var(&script_snippet, "revisions", opts->revisions);
 	add_var(&script_snippet, "restrict_revision", opts->restrict_revision ?
 		oid_to_hex(&opts->restrict_revision->object.oid) : NULL);
+	add_var(&script_snippet, "GIT_QUIET",
+		opts->flags & REBASE_NO_QUIET ? "" : "t");
+	add_var(&script_snippet, "git_am_opt", opts->git_am_opt.buf);
 
 	switch (opts->type) {
 	case REBASE_AM:
@@ -308,6 +315,8 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 {
 	struct rebase_options options = {
 		.type = REBASE_UNSPECIFIED,
+		.flags = REBASE_NO_QUIET,
+		.git_am_opt = STRBUF_INIT,
 	};
 	const char *branch_name;
 	int ret, flags;
@@ -321,6 +330,9 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			   N_("rebase onto given branch instead of upstream")),
 		OPT_BOOL(0, "no-verify", &ok_to_skip_pre_rebase,
 			 N_("allow pre-rebase hook to run")),
+		OPT_NEGBIT('q', "quiet", &options.flags,
+			   N_("be quiet. implies --no-stat"),
+			   REBASE_NO_QUIET),
 		OPT_END(),
 	};
 
@@ -357,6 +369,9 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		usage_with_options(builtin_rebase_usage,
 				   builtin_rebase_options);
 
+	if (!(options.flags & REBASE_NO_QUIET))
+		strbuf_addstr(&options.git_am_opt, " -q");
+
 	switch (options.type) {
 	case REBASE_MERGE:
 	case REBASE_INTERACTIVE:
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 31A91208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:31 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727345AbeHHQLP (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:15 -0400
Received: from mail-ed1-f67.google.com ([209.85.208.67]:47070 "EHLO
        mail-ed1-f67.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727048AbeHHQLP (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:15 -0400
Received: by mail-ed1-f67.google.com with SMTP id o8-v6so1274452edt.13
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:28 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=ltj4Ypxht+lzTgXCZEcrwAcbNsmKqqInH8vDQEwAfMs=;
        b=sYNlHC4+Xs4ykr1nvUxA2qDa2hxb8hfSZ7CwGpC93GL7UkNSFab4G5H6c2UTefEi4j
         IO/e1gcWFlTNjJndEvRPmx4dWB+9fsnsnpI2BgbJp2tcyhJ+VXRaShHPd+jd5Y+Go7Bm
         3N9zFVtBvklQtiTnH/ealwP0+nWshVMXhVlm4WQOvUEluUcAIYPNkgR6nBLslkkZISRH
         UuQR+GFeatofN0mRMVoMlTfPveSL24ItZNhAbsQc8yRjT1MJ0KhjEdU8fdMVIL4YUkXI
         VP5SVMrn6Hf0kj9VG1Qy7QT5JcAmB9j1l+mO2X9cupS3VCTxgmDudcr4Mju7CCcZsS+U
         YtJw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=ltj4Ypxht+lzTgXCZEcrwAcbNsmKqqInH8vDQEwAfMs=;
        b=cMi4ibNaZ48WTyzDkHsDFXcMTXNAVkJ7w3sbDAIl3WVTWjXitlY901PzG/l2QMplCZ
         r4qNQuHxQLNQHJHB3ObA0P9dA7XMguht1VbUaeWYs4ExhZBE9X9CfUketyA2VAGWsFnh
         MJXQCEQF0FlJar/zJPAo8jz+dHp/nKDWPxQIvcF1jOzV6dQfzlzxw6b5tjhWOMCdSAqB
         HHVbEaKxgwrqCz4VlTwRzQvlJxOUNFfsOJTAAYKcBBJRUVe5iq5O9V4r/YH43oTCUOdl
         pNKSn/RYCXj9Wxq7c5OJ9OL8D4y0D3/LBWcWlYCuwSYYNMQxjjnE5tIxij9vSnvOUJtI
         IuVg==
X-Gm-Message-State: AOUpUlF7RgWLFNMzKnreub4WMmt7FEiiKNd96ChvNaJ0C3sEIc3H6/XW
        3lscYwHbjHy5JP9HxmG4hwGukxJc
X-Google-Smtp-Source: AA+uWPyGdfMSww4Ee1rzbnYJK5AvJqHb/E3WwAFcEUT3eRiByS0/+jjZdRjHb+DLBl2ZFOxt7iTehQ==
X-Received: by 2002:a50:f098:: with SMTP id v24-v6mr3392072edl.90.1533736287583;
        Wed, 08 Aug 2018 06:51:27 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.24
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:26 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 05/11] builtin rebase: support the `verbose` and `diffstat` options
Date:   Wed,  8 Aug 2018 19:33:24 +0545
Message-Id: <20180808134830.19949-6-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-6-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit introduces support for the `-v` and `--stat` options of
rebase.

The --stat option can also be configured via the Git config setting
rebase.stat. To support this, we also add a custom rebase_config()
function in this commit that will be used instead of (and falls back to
calling) git_default_config().

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 60 ++++++++++++++++++++++++++++++++++++++++++++++--
 1 file changed, 58 insertions(+), 2 deletions(-)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 19fa4d3fc4..2d3f1d65fb 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -18,6 +18,7 @@
 #include "lockfile.h"
 #include "parse-options.h"
 #include "commit.h"
+#include "diff.h"
 
 static char const * const builtin_rebase_usage[] = {
 	N_("git rebase [-i] [options] [--exec <cmd>] [--onto <newbase>] "
@@ -81,6 +82,8 @@ struct rebase_options {
 	int dont_finish_rebase;
 	enum {
 		REBASE_NO_QUIET = 1<<0,
+		REBASE_VERBOSE = 1<<1,
+		REBASE_DIFFSTAT = 1<<2,
 	} flags;
 	struct strbuf git_am_opt;
 };
@@ -166,6 +169,10 @@ static int run_specific_rebase(struct rebase_options *opts)
 	add_var(&script_snippet, "GIT_QUIET",
 		opts->flags & REBASE_NO_QUIET ? "" : "t");
 	add_var(&script_snippet, "git_am_opt", opts->git_am_opt.buf);
+	add_var(&script_snippet, "verbose",
+		opts->flags & REBASE_VERBOSE ? "t" : "");
+	add_var(&script_snippet, "diffstat",
+		opts->flags & REBASE_DIFFSTAT ? "t" : "");
 
 	switch (opts->type) {
 	case REBASE_AM:
@@ -311,6 +318,21 @@ static int reset_head(struct object_id *oid, const char *action,
 	return ret;
 }
 
+static int rebase_config(const char *var, const char *value, void *data)
+{
+	struct rebase_options *opts = data;
+
+	if (!strcmp(var, "rebase.stat")) {
+		if (git_config_bool(var, value))
+			opts->flags |= REBASE_DIFFSTAT;
+		else
+			opts->flags &= !REBASE_DIFFSTAT;
+		return 0;
+	}
+
+	return git_default_config(var, value, data);
+}
+
 int cmd_rebase(int argc, const char **argv, const char *prefix)
 {
 	struct rebase_options options = {
@@ -332,7 +354,13 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			 N_("allow pre-rebase hook to run")),
 		OPT_NEGBIT('q', "quiet", &options.flags,
 			   N_("be quiet. implies --no-stat"),
-			   REBASE_NO_QUIET),
+			   REBASE_NO_QUIET| REBASE_VERBOSE | REBASE_DIFFSTAT),
+		OPT_BIT('v', "verbose", &options.flags,
+			N_("display a diffstat of what changed upstream"),
+			REBASE_NO_QUIET | REBASE_VERBOSE | REBASE_DIFFSTAT),
+		{OPTION_NEGBIT, 'n', "no-stat", &options.flags, NULL,
+			N_("do not show diffstat of what changed upstream"),
+			PARSE_OPT_NOARG, NULL, REBASE_DIFFSTAT },
 		OPT_END(),
 	};
 
@@ -360,7 +388,8 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	trace_repo_setup(prefix);
 	setup_work_tree();
 
-	git_config(git_default_config, NULL);
+	git_config(rebase_config, &options);
+
 	argc = parse_options(argc, argv, prefix,
 			     builtin_rebase_options,
 			     builtin_rebase_usage, 0);
@@ -456,6 +485,33 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			argc ? argv[0] : NULL, NULL))
 		die(_("The pre-rebase hook refused to rebase."));
 
+	if (options.flags & REBASE_DIFFSTAT) {
+		struct diff_options opts;
+
+		if (options.flags & REBASE_VERBOSE)
+			printf(_("Changes from %s to %s:\n"),
+				oid_to_hex(&merge_base),
+				oid_to_hex(&options.onto->object.oid));
+
+		/* We want color (if set), but no pager */
+		diff_setup(&opts);
+		opts.stat_width = -1; /* use full terminal width */
+		opts.stat_graph_width = -1; /* respect statGraphWidth config */
+		opts.output_format |=
+			DIFF_FORMAT_SUMMARY | DIFF_FORMAT_DIFFSTAT;
+		opts.detect_rename = DIFF_DETECT_RENAME;
+		diff_setup_done(&opts);
+		diff_tree_oid(&merge_base, &options.onto->object.oid,
+			      "", &opts);
+		diffcore_std(&opts);
+		diff_flush(&opts);
+	}
+
+	/* Detach HEAD and reset the tree */
+	if (options.flags & REBASE_NO_QUIET)
+		printf(_("First, rewinding head to replay your work on top of "
+			 "it...\n"));
+
 	strbuf_addf(&msg, "rebase: checkout %s", options.onto_name);
 	if (reset_head(&options.onto->object.oid, "checkout", NULL, 1))
 		die(_("Could not detach HEAD"));
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 18F91208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:34 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727348AbeHHQLS (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:18 -0400
Received: from mail-ed1-f66.google.com ([209.85.208.66]:46009 "EHLO
        mail-ed1-f66.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727048AbeHHQLS (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:18 -0400
Received: by mail-ed1-f66.google.com with SMTP id s16-v6so1275318edq.12
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:32 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=U+tkIKfwGf7uHVP3WtbLHYmHb4cJT/OFTAHyvQ7RZtk=;
        b=JhjktLpgwnZjS8ASYEBLwjrQlOXyj4p8bqOaltmAijRib1bxhBVCtkrt3YKLjeMtwG
         Ti0evgpUTyXWpQBJru5HqABlvL5MmAAgQnSGQXFVxHbOKoIm5XjMX+7GRaMP5ib9Pt9O
         MsAOmexvN8/DDpVmdU1hkTkujxjqZuqpsZ92VJAoxbIicetBHdfr0rOkAH+8WJmuLjxD
         RDAFnyfgcMGi0CcdC0+PmHO3MRdGQmkYfIv9WLpz0yiPBZQ1XX5RM0DL1XRwfqp1KVi0
         3pPUg+hvEUndwKZr6Qz32vr4SGgUKz5YC7FXjFl1MC5gixn08lvSLDfArzose7xqrIcn
         dYNg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=U+tkIKfwGf7uHVP3WtbLHYmHb4cJT/OFTAHyvQ7RZtk=;
        b=GXgee3VG9NH8fcJzHeBDLqsmJhyFftAtuIzgD1Nw8eFspoj08JPR3Wq7Gp6JFFisAd
         kYceEzqJdN2ybxd/OxiuPVfXb5SqwBSyiz4OwFUIbsywlNgSy71uNjYqczVNCL0gQ/Ip
         Ma2d1K6NbO/39AF3JRG9+w1RAbGay5RKS305ol1qWsIu/YFz0vz7Y+Z3AGqL36INGM8D
         T3/BKfvmriOhMGf4qDbgIXhaXpvm8JsE7Uq3vclr0JeBw1Ke919QdkRywWC2OSbfZvup
         V+SfWXNIzSTnVQTTuykhNKliByE+Wu9CGHdqdUUtKg/Ozv6aGlC4+qYWonz6vq7FSvr9
         qGug==
X-Gm-Message-State: AOUpUlGalhcEooEUB27s7ru8YfRZXDYS1F0VQG5hDzH6mYMfYwq4TjdC
        KynF7AAZdAColKhZo9hV922plJdd
X-Google-Smtp-Source: AA+uWPxwZAoCJWoqWGhJUKJBNbAjdxTfMnMz1y7DHvkCB+KTVM5VtszelzOFmAC5icZmiYq1GYuRxQ==
X-Received: by 2002:a50:8607:: with SMTP id o7-v6mr3338049edo.243.1533736291243;
        Wed, 08 Aug 2018 06:51:31 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.27
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:30 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 06/11] builtin rebase: require a clean worktree
Date:   Wed,  8 Aug 2018 19:33:25 +0545
Message-Id: <20180808134830.19949-7-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-7-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit reads the index of the repository for rebase and checks
whether the repository is ready for rebase.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 2d3f1d65fb..afef0b0046 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -19,6 +19,7 @@
 #include "parse-options.h"
 #include "commit.h"
 #include "diff.h"
+#include "wt-status.h"
 
 static char const * const builtin_rebase_usage[] = {
 	N_("git rebase [-i] [options] [--exec <cmd>] [--onto <newbase>] "
@@ -479,6 +480,15 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			die(_("Could not resolve HEAD to a revision"));
 	}
 
+	if (read_index(the_repository->index) < 0)
+		die(_("could not read index"));
+
+	if (require_clean_work_tree("rebase",
+				    _("Please commit or stash them."), 1, 1)) {
+		ret = 1;
+		goto cleanup;
+	}
+
 	/* If a hook exists, give it a chance to interrupt*/
 	if (!ok_to_skip_pre_rebase &&
 	    run_hook_le(NULL, "pre-rebase", options.upstream_arg,
@@ -528,6 +538,7 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 
 	ret = !!run_specific_rebase(&options);
 
+cleanup:
 	strbuf_release(&revisions);
 	free(options.head_name);
 	return ret;
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 71FA5208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:38 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727352AbeHHQLX (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:23 -0400
Received: from mail-ed1-f67.google.com ([209.85.208.67]:35444 "EHLO
        mail-ed1-f67.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727048AbeHHQLW (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:22 -0400
Received: by mail-ed1-f67.google.com with SMTP id e6-v6so1308944edr.2
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:35 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=fx4hkZfH1JQQr9jOoRq9vfyP06SdNCsK3DoGdzNS7Tg=;
        b=mJAEopyLvFN5Hj1RqF8yWBfJ46wBrPmFhDVGUadNGGEvD/8ncGWGABTjMQg5YTsgU/
         MvPIx34OZNxV2SJwuALrm7AyjSKNTAP4eymgOHB4U1R7iZ15iKcdwG4CM5FitXBsP8i7
         J8Hg9PpB+/UshxY4z7WKgSQDDimidQzusJ9nnm0R5a6lwzkr9z9nQT4UbAUzLLS7uISq
         XG/lqHFnkr5IkRRVA2JhrS5PM1ZNuniSAhaYg15/eGVE1/wBpYWElIGDCoNYai9r6tth
         d5uET6DiYNXU5QZR5NkxiMAKf2hCek+hO6ThPQyc2o2h75QgeJnNNJYL28wj4DW7DEY/
         Ex2g==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=fx4hkZfH1JQQr9jOoRq9vfyP06SdNCsK3DoGdzNS7Tg=;
        b=hkO0h1+/bJCGi585ijT1L1r+QAzFhaW+lY6YeVX42Hdwa+CULlnI7BwkmUkqLS8Wge
         5Ok0F/KCTuddsklGFDLo9viJonb7lR9iPgfn/P2KfmpjMXW0FSsbM5Nsjp6a0ohnwJEY
         jwmjwsP2I7C3mUffHFEQj5AF3rGDNLjTSDsfep1d4yQEx3dasje7INjUgfvLjyOqZrPw
         ZT1Np8HScfH6R/z6FvzAxiWxurtx/IiVOemCeqxF8WRj2ClsJ3iWg95JC5+38bVA48hH
         rpGF+jnZyaKkKYCgPIaVWGKAg/TgMDr44RLHyjt4FgSeNJwwozWNVSyLzrhwQnVdT+05
         rLSg==
X-Gm-Message-State: AOUpUlGolFD6uj33ftaoA2GyVZLoPR69qVBc9usY4bdtw+tGWwuLhF7z
        hg8LpQ4u9XwQoTceNrDAqPmBhb9n
X-Google-Smtp-Source: AA+uWPx5aZZWartAhJy0BGJMZcE0Qa7ssekAWueo4+mcBtFQ18RYXVFVelwVVltoGb8LiYlwBYeJBQ==
X-Received: by 2002:a50:8345:: with SMTP id 63-v6mr3271280edh.5.1533736295033;
        Wed, 08 Aug 2018 06:51:35 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.31
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:34 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 07/11] builtin rebase: try to fast forward when possible
Date:   Wed,  8 Aug 2018 19:33:26 +0545
Message-Id: <20180808134830.19949-8-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-8-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

In this commit, we add support to fast forward.

Note: we will need the merge base later, therefore the call to
can_fast_forward() really needs to be the first one when testing whether
we can skip the rebase entirely (otherwise, it would make more sense to
skip the possibly expensive operation if, say, running an interactive
rebase).

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 72 ++++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 72 insertions(+)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index afef0b0046..52a218cd18 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -20,6 +20,7 @@
 #include "commit.h"
 #include "diff.h"
 #include "wt-status.h"
+#include "revision.h"
 
 static char const * const builtin_rebase_usage[] = {
 	N_("git rebase [-i] [options] [--exec <cmd>] [--onto <newbase>] "
@@ -89,6 +90,12 @@ struct rebase_options {
 	struct strbuf git_am_opt;
 };
 
+static int is_interactive(struct rebase_options *opts)
+{
+	return opts->type == REBASE_INTERACTIVE ||
+		opts->type == REBASE_PRESERVE_MERGES;
+}
+
 /* Returns the filename prefixed by the state_dir */
 static const char *state_dir_path(const char *filename, struct rebase_options *opts)
 {
@@ -334,6 +341,46 @@ static int rebase_config(const char *var, const char *value, void *data)
 	return git_default_config(var, value, data);
 }
 
+/*
+ * Determines whether the commits in from..to are linear, i.e. contain
+ * no merge commits. This function *expects* `from` to be an ancestor of
+ * `to`.
+ */
+static int is_linear_history(struct commit *from, struct commit *to)
+{
+	while (to && to != from) {
+		parse_commit(to);
+		if (!to->parents)
+			return 1;
+		if (to->parents->next)
+			return 0;
+		to = to->parents->item;
+	}
+	return 1;
+}
+
+static int can_fast_forward(struct commit *onto, struct object_id *head_oid,
+			    struct object_id *merge_base)
+{
+	struct commit *head = lookup_commit(the_repository, head_oid);
+	struct commit_list *merge_bases;
+	int res;
+
+	if (!head)
+		return 0;
+
+	merge_bases = get_merge_bases(onto, head);
+	if (merge_bases && !merge_bases->next) {
+		oidcpy(merge_base, &merge_bases->item->object.oid);
+		res = !oidcmp(merge_base, &onto->object.oid);
+	} else {
+		oidcpy(merge_base, &null_oid);
+		res = 0;
+	}
+	free_commit_list(merge_bases);
+	return res && is_linear_history(onto, head);
+}
+
 int cmd_rebase(int argc, const char **argv, const char *prefix)
 {
 	struct rebase_options options = {
@@ -489,6 +536,31 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		goto cleanup;
 	}
 
+	/*
+	 * Now we are rebasing commits upstream..orig_head (or with --root,
+	 * everything leading up to orig_head) on top of onto.
+	 */
+
+	/*
+	 * Check if we are already based on onto with linear history,
+	 * but this should be done only when upstream and onto are the same
+	 * and if this is not an interactive rebase.
+	 */
+	if (can_fast_forward(options.onto, &options.orig_head, &merge_base) &&
+	    !is_interactive(&options) && !options.restrict_revision &&
+	    !oidcmp(&options.upstream->object.oid, &options.onto->object.oid)) {
+		int flag;
+
+		if (!(options.flags & REBASE_NO_QUIET))
+			; /* be quiet */
+		else if (!strcmp(branch_name, "HEAD") &&
+			resolve_ref_unsafe("HEAD", 0, NULL, &flag))
+			puts(_("HEAD is up to date, rebase forced."));
+		else
+			printf(_("Current branch %s is up to date, rebase "
+				 "forced.\n"), branch_name);
+	}
+
 	/* If a hook exists, give it a chance to interrupt*/
 	if (!ok_to_skip_pre_rebase &&
 	    run_hook_le(NULL, "pre-rebase", options.upstream_arg,
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id DD35C208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:41 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727360AbeHHQL0 (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:26 -0400
Received: from mail-ed1-f67.google.com ([209.85.208.67]:35451 "EHLO
        mail-ed1-f67.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727048AbeHHQL0 (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:26 -0400
Received: by mail-ed1-f67.google.com with SMTP id e6-v6so1309056edr.2
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:39 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=FvfuVWeQcgCkBbCN3zCkvoa/l7e+1Ge/PFXHGlg0TCM=;
        b=XIF4SJSPNW6wodL4R2FLZNKVALJuogfYJthizCIKQkpU1LBcckSHkrhGD3iYh+1rkr
         J274rMb7N3PeuetdEWxhol+F4uwpocrloKQXhL+lJklGw+qCblc9QYNIWkrKQ1Q6949c
         7xb2p4kHjfmKArWKwtn/xH1duMSBE0ybsJ4m69UTdPR4wNlxgLwqtJChsWuKvyH/JSj+
         jDpS+0eRTVdoYpVuDs97BGj4mcJWUN6L5Y9/KC8T6d231PBP5dLWR74fX9juXxIg0ZIL
         vKDWQUP2rz4aUXXHnTO9iilrwzgIet2Ek/SafBSIyEX3q2H9rxDNIqBZVC44wrYmoaN+
         r3gg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=FvfuVWeQcgCkBbCN3zCkvoa/l7e+1Ge/PFXHGlg0TCM=;
        b=MDrH9uafYr2ceDfBgpp3UFHIcYbcvNejGBE1ww8BIgRLRYdEOEmQi7BYqUWOIkm/aw
         JaKZQzX6sbgCVeNfaHoKthM23+PajTB/jisPUhaV6xBWub06x1lyvRvgUD8yLCgvIQ/K
         +GXMDDaq/xzFy3tQcCXXgApvg+fnhi1HuH0W7BroU/QDrrW+tBlVG8tgVDHBHGIvI1XD
         otNiC/tgCIpEUvYca4OljZr7fO9omKiZ+ybkZBdjTxrtTw3r/0vF1ZJ6/ShlV+Vox5xn
         teiNaYVM7+94qQPaFpA+sFKrjPQR8V0pX13nttKrnGIlGYKq81DZ2UCHFB6vMDgNjWXw
         VWfw==
X-Gm-Message-State: AOUpUlGt8wasznTZlcvMZI8yqMNSgcw8SExVwHZsB9hj2GqTFSD07eAN
        s2smYhX7y0kCuAIgWtisF/92T1u4
X-Google-Smtp-Source: AA+uWPwp4ah5YHk5Aq12I2kakz7bTvlcENzyzpeHXA0jCiPjkB7UC6yRQFLqfNCJIp9xsbCSJZcgfQ==
X-Received: by 2002:a50:ac65:: with SMTP id w34-v6mr3398066edc.211.1533736298810;
        Wed, 08 Aug 2018 06:51:38 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.35
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:38 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 08/11] builtin rebase: support --force-rebase
Date:   Wed,  8 Aug 2018 19:33:27 +0545
Message-Id: <20180808134830.19949-9-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-9-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

In this commit, we add support to `--force-rebase` option. The
equivalent part of the shell script found in `git-legacy-rebase.sh` is
converted as faithfully as possible to C.

The --force-rebase option ensures that the rebase does not simply
fast-forward even if it could.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 24 ++++++++++++++++++++++--
 1 file changed, 22 insertions(+), 2 deletions(-)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 52a218cd18..8a7bf3d468 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -86,6 +86,7 @@ struct rebase_options {
 		REBASE_NO_QUIET = 1<<0,
 		REBASE_VERBOSE = 1<<1,
 		REBASE_DIFFSTAT = 1<<2,
+		REBASE_FORCE = 1<<3,
 	} flags;
 	struct strbuf git_am_opt;
 };
@@ -181,6 +182,8 @@ static int run_specific_rebase(struct rebase_options *opts)
 		opts->flags & REBASE_VERBOSE ? "t" : "");
 	add_var(&script_snippet, "diffstat",
 		opts->flags & REBASE_DIFFSTAT ? "t" : "");
+	add_var(&script_snippet, "force_rebase",
+		opts->flags & REBASE_FORCE ? "t" : "");
 
 	switch (opts->type) {
 	case REBASE_AM:
@@ -409,6 +412,12 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		{OPTION_NEGBIT, 'n', "no-stat", &options.flags, NULL,
 			N_("do not show diffstat of what changed upstream"),
 			PARSE_OPT_NOARG, NULL, REBASE_DIFFSTAT },
+		OPT_BIT('f', "force-rebase", &options.flags,
+			N_("cherry-pick all commits, even if unchanged"),
+			REBASE_FORCE),
+		OPT_BIT(0, "no-ff", &options.flags,
+			N_("cherry-pick all commits, even if unchanged"),
+			REBASE_FORCE),
 		OPT_END(),
 	};
 
@@ -551,10 +560,21 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	    !oidcmp(&options.upstream->object.oid, &options.onto->object.oid)) {
 		int flag;
 
-		if (!(options.flags & REBASE_NO_QUIET))
+		if (!(options.flags & REBASE_FORCE)) {
+			if (!(options.flags & REBASE_NO_QUIET))
+				; /* be quiet */
+			else if (!strcmp(branch_name, "HEAD") &&
+				 resolve_ref_unsafe("HEAD", 0, NULL, &flag))
+				puts(_("HEAD is up to date."));
+			else
+				printf(_("Current branch %s is up to date.\n"),
+				       branch_name);
+			ret = !!finish_rebase(&options);
+			goto cleanup;
+		} else if (!(options.flags & REBASE_NO_QUIET))
 			; /* be quiet */
 		else if (!strcmp(branch_name, "HEAD") &&
-			resolve_ref_unsafe("HEAD", 0, NULL, &flag))
+			 resolve_ref_unsafe("HEAD", 0, NULL, &flag))
 			puts(_("HEAD is up to date, rebase forced."));
 		else
 			printf(_("Current branch %s is up to date, rebase "
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 8F74B208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:45 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727364AbeHHQLa (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:30 -0400
Received: from mail-ed1-f65.google.com ([209.85.208.65]:35454 "EHLO
        mail-ed1-f65.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727048AbeHHQLa (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:30 -0400
Received: by mail-ed1-f65.google.com with SMTP id e6-v6so1309154edr.2
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:43 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=o5FHiG1/DMx/Q+OKRW9D9GjYSop/vkQA/qvKY4NJoAk=;
        b=PjmtS6P0PqcnOZEJUXrTzW84nmfIuTMKEmiOqScq+dKNQr6z3Hx4Q8obKgRACr/H4s
         oOGAeHj0wk+k/bYQu8M9VPaQ4fv8TEbL8YB/5KftF17Ny//IrJO1PMJ165G27qSdPAeO
         QpC4JTaPIEgS0+6xXT7pVZ36xM40L2+fECBdXlkw5T+S66f8hwv26AO6R+dLNvXgmzDJ
         abC8oxV4UVDVdpLZVTQ8YVn6P1srKIQW9x93Ow5okyilZAKYiCzfGdTF8wZPIM/pMyfL
         4Tima/3VB0cGPygx2C89njJgTPVjHX81Vho+WQGKctVP3RQnzgRESSDZfDMywVYf2mbS
         1a1Q==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=o5FHiG1/DMx/Q+OKRW9D9GjYSop/vkQA/qvKY4NJoAk=;
        b=FMWZqC4nSCnRk+fT+LPY1yPM0Y5G/IHyFm9IVduqNy3WAIZ7yLzCspwzseEL+nPKgS
         3ohh4S81uFJqK5qXQVKwtQMRZIo3zx75G4ad4NZVoereasEPlE/RwUc2WkJ1Lpvi5cuB
         0pDnXo+Mew9SJ37Qss497oc645vp9wXxXAXM8LvG03q2huOwTdUgBqg4qxHvOGfoVrKH
         hKmSUF8P/Q22XK4Tdvp//I7R06NrI+foOK0tEJiCTTGUhv3sZGU/ydmZNTn3ldQPg/cj
         fBasKSCfZlJNLFQI1GiiLkp32RLUIHGKNVMrLR/K/v3BlOt/kYsajUqZrfZEmNopLEZY
         yC1A==
X-Gm-Message-State: AOUpUlHPP+l3/G1GBcldY2+CL1uHEmH4YwMbM3FwK5NkydfLE5aBAK8d
        Frh5YS50Yug4gmKmHgWAz5QbRxJY
X-Google-Smtp-Source: AA+uWPx4z0h65w6bNz1oroqIx2JTS5axDAV4ix9bINPtIjmDGFqWFLrJTUC/TQW3PXPEQz7ctPW9sw==
X-Received: by 2002:a50:a402:: with SMTP id u2-v6mr3268733edb.237.1533736302487;
        Wed, 08 Aug 2018 06:51:42 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.39
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:41 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 09/11] builtin rebase: start a new rebase only if none is in progress
Date:   Wed,  8 Aug 2018 19:33:28 +0545
Message-Id: <20180808134830.19949-10-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-10-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

To run a new rebase, there needs to be a check to assure that no other
rebase is in progress. New rebase operation cannot start until an
ongoing rebase operation completes or is terminated.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 48 +++++++++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 47 insertions(+), 1 deletion(-)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 8a7bf3d468..a261f552f1 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -87,6 +87,7 @@ struct rebase_options {
 		REBASE_VERBOSE = 1<<1,
 		REBASE_DIFFSTAT = 1<<2,
 		REBASE_FORCE = 1<<3,
+		REBASE_INTERACTIVE_EXPLICIT = 1<<4,
 	} flags;
 	struct strbuf git_am_opt;
 };
@@ -392,10 +393,11 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		.git_am_opt = STRBUF_INIT,
 	};
 	const char *branch_name;
-	int ret, flags;
+	int ret, flags, in_progress = 0;
 	int ok_to_skip_pre_rebase = 0;
 	struct strbuf msg = STRBUF_INIT;
 	struct strbuf revisions = STRBUF_INIT;
+	struct strbuf buf = STRBUF_INIT;
 	struct object_id merge_base;
 	struct option builtin_rebase_options[] = {
 		OPT_STRING(0, "onto", &options.onto_name,
@@ -447,6 +449,30 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 
 	git_config(rebase_config, &options);
 
+	if (is_directory(apply_dir())) {
+		options.type = REBASE_AM;
+		options.state_dir = apply_dir();
+	} else if (is_directory(merge_dir())) {
+		strbuf_reset(&buf);
+		strbuf_addf(&buf, "%s/rewritten", merge_dir());
+		if (is_directory(buf.buf)) {
+			options.type = REBASE_PRESERVE_MERGES;
+			options.flags |= REBASE_INTERACTIVE_EXPLICIT;
+		} else {
+			strbuf_reset(&buf);
+			strbuf_addf(&buf, "%s/interactive", merge_dir());
+			if(file_exists(buf.buf)) {
+				options.type = REBASE_INTERACTIVE;
+				options.flags |= REBASE_INTERACTIVE_EXPLICIT;
+			} else
+				options.type = REBASE_MERGE;
+		}
+		options.state_dir = merge_dir();
+	}
+
+	if (options.type != REBASE_UNSPECIFIED)
+		in_progress = 1;
+
 	argc = parse_options(argc, argv, prefix,
 			     builtin_rebase_options,
 			     builtin_rebase_usage, 0);
@@ -455,6 +481,26 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		usage_with_options(builtin_rebase_usage,
 				   builtin_rebase_options);
 
+	/* Make sure no rebase is in progress */
+	if (in_progress) {
+		const char *last_slash = strrchr(options.state_dir, '/');
+		const char *state_dir_base =
+			last_slash ? last_slash + 1 : options.state_dir;
+		const char *cmd_live_rebase =
+			"git rebase (--continue | --abort | --skip)";
+		strbuf_reset(&buf);
+		strbuf_addf(&buf, "rm -fr \"%s\"", options.state_dir);
+		die(_("It seems that there is already a %s directory, and\n"
+		      "I wonder if you are in the middle of another rebase.  "
+		      "If that is the\n"
+		      "case, please try\n\t%s\n"
+		      "If that is not the case, please\n\t%s\n"
+		      "and run me again.  I am stopping in case you still "
+		      "have something\n"
+		      "valuable there.\n"),
+		    state_dir_base, cmd_live_rebase,buf.buf);
+	}
+
 	if (!(options.flags & REBASE_NO_QUIET))
 		strbuf_addstr(&options.git_am_opt, " -q");
 
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 3532D208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:49 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727370AbeHHQLd (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:33 -0400
Received: from mail-ed1-f66.google.com ([209.85.208.66]:43894 "EHLO
        mail-ed1-f66.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727048AbeHHQLd (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:33 -0400
Received: by mail-ed1-f66.google.com with SMTP id j21-v6so1284973edp.10
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:46 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=kuGs0o3e94evsB1FEupXT5BGmmSwaiNBSdnGz5Z5150=;
        b=aAKNMWkgmBiv5SVutzSMQ8pyoYePID7eN5dYbdulWco8WhwueO4CJLGNf4HCpl/92D
         /q4FSuUpzFk6rWZg36dNM2ybCpcqe11KMSEXK5ZZjCUEP7yFcxJ3HpNkuJYf/IzPENFt
         tl2bCudacZjuiSE0Odq77j2kee79wDbni/l7cXXaRuolk+rj1tRTbBkNtWGzxbaGdk5m
         7XSWQGEs+g51TLqCyoKE5ud9wsIeRbOC4yfsCk9ZztpLb/vzQgH+dqtoFmPfy+a16egP
         36hnmU66Hj4AMqgnZVbflWUFVLfvKNRwsW7hHDsrO9diwj/9IMc/FfMIu+RwxA7TfXHO
         g23A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=kuGs0o3e94evsB1FEupXT5BGmmSwaiNBSdnGz5Z5150=;
        b=blzeXowUN1d9Rf2fpII5bGeYiF5ASWS1evjP3Ds+WwT9ssEbSNnLD1DuZ4orl3c6sx
         oyO/j5h5MEcR26BdEi/z7K5T/VbU/HjQiUgE591glhhihlWBE71C7fZd0riODR6s/+/T
         ESA/R9Lnj7wOdCMqKDlYl1fca8QAmt0tZAfMX+32zJgLPNzKjT01cnLaIp9dgv5letGb
         uNdrrIpz/pYl8hp4L7Dt0Ojf5qNNSF4A+vd8l89t0e3vOI+FSl9JR8n9zYUc/7K4xyZp
         FodHcns3VqMJ9vzl+cufPIHtmirJMGN1MShxgeXLQbUmbVB+sguiTLbenNAxbZE89R0G
         SIpw==
X-Gm-Message-State: AOUpUlHqUEtUvRGi4uVV5gmgj/ai66Ce5OEMu/qqhns1l+D1q5UDchKf
        kXq6f9OeRwtVeRXXewOO6ScvfTjk
X-Google-Smtp-Source: AA+uWPxGHb1Y/az1VTBt3E96ekaQSrjEtO8gGpHYgtFQczL17cx6lyOGNr4s8EdZPbjfdVrDpjVB/A==
X-Received: by 2002:a50:9818:: with SMTP id g24-v6mr3509018edb.174.1533736306140;
        Wed, 08 Aug 2018 06:51:46 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.42
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:45 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 10/11] builtin rebase: only store fully-qualified refs in `options.head_name`
Date:   Wed,  8 Aug 2018 19:33:29 +0545
Message-Id: <20180808134830.19949-11-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-11-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

When running a rebase on a detached HEAD, we currently store the string
"detached HEAD" in options.head_name. That is a faithful translation of
the shell script version, and we still kind of need it for the purposes of
the scripted backends.

It is poor style for C, though, where we would really only want a valid,
fully-qualified ref name as value, and NULL for detached HEADs, using
"detached HEAD" for display only. Make it so.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index a261f552f1..63634210c0 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -169,7 +169,8 @@ static int run_specific_rebase(struct rebase_options *opts)
 	add_var(&script_snippet, "upstream_name", opts->upstream_name);
 	add_var(&script_snippet, "upstream",
 				 oid_to_hex(&opts->upstream->object.oid));
-	add_var(&script_snippet, "head_name", opts->head_name);
+	add_var(&script_snippet, "head_name",
+		opts->head_name ? opts->head_name : "detached HEAD");
 	add_var(&script_snippet, "orig_head", oid_to_hex(&opts->orig_head));
 	add_var(&script_snippet, "onto", oid_to_hex(&opts->onto->object.oid));
 	add_var(&script_snippet, "onto_name", opts->onto_name);
@@ -251,6 +252,9 @@ static int reset_head(struct object_id *oid, const char *action,
 		*old_orig = NULL, oid_old_orig;
 	int ret = 0;
 
+	if (switch_to_branch && !starts_with(switch_to_branch, "refs/"))
+		BUG("Not a fully qualified branch: '%s'", switch_to_branch);
+
 	if (hold_locked_index(&lock, LOCK_REPORT_ON_ERROR) < 0)
 		return -1;
 
@@ -558,7 +562,7 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	 * branch_name -- branch/commit being rebased, or
 	 * 		  HEAD (already detached)
 	 * orig_head -- commit object name of tip of the branch before rebasing
-	 * head_name -- refs/heads/<that-branch> or "detached HEAD"
+	 * head_name -- refs/heads/<that-branch> or NULL (detached HEAD)
 	 */
 	if (argc > 0)
 		 die("TODO: handle switch_to");
@@ -575,7 +579,8 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 				branch_name = options.head_name;
 
 		} else {
-			options.head_name = xstrdup("detached HEAD");
+			free(options.head_name);
+			options.head_name = NULL;
 			branch_name = "HEAD";
 		}
 		if (get_oid("HEAD", &options.orig_head))
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.0 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id E2E74208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 13:51:52 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727381AbeHHQLh (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 12:11:37 -0400
Received: from mail-ed1-f67.google.com ([209.85.208.67]:42398 "EHLO
        mail-ed1-f67.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727048AbeHHQLh (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 12:11:37 -0400
Received: by mail-ed1-f67.google.com with SMTP id r4-v6so1281890edp.9
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 06:51:50 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=xqccnSSZh25PfAn9kX6uhY/hwmuGU9my1HHJZ7TLspY=;
        b=crjzpNDFrch3p50bUFRZBgldt9Chx27KR7+kEdHEEfYAux+DJ9MVwfRkK44Tggc1aO
         w6TPQ3xygW47TS0yGF6q90xjpCiuWNujy8GokwQl9YhVLaK5Hlc0gJ+cW2B5WCzyKHqv
         NVkJTpPYXRJkqtbwCGzmFSZTQ7i0NxChmt3BkWW4CRgo/+GYP0homyYXCGyI33wWnegA
         QlsQzjv8w2bBi2r3G/UQaOod4H7pf+pu1vpP8Q8cgLh9S5Z5RgE7OoL8S4YZnR5Z5b5E
         yRZ4KqGqCaZZbjEpesJ5lwwqhA7dcIoS5pTsh3lZ5CiZRKoNqk5gEgJn9SzorEpKZSYz
         8iqw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=xqccnSSZh25PfAn9kX6uhY/hwmuGU9my1HHJZ7TLspY=;
        b=V/zQay982SivedOHwjbU8mpIiHpKLqwkS6ISv/hIuY8LdExodgRuyYIr6pqoPoEeAL
         udJrZrJ+F0qpmU2qV1tMUfusKIN5pX7T63SizEaFcZzqVqk1FxPeu0k1OWiUTXJwE+aJ
         hNXPK5HOd5FNhp+cqPzuZpqHydUBbCvprE4SVjkc6z/5LFeyhomEJhNuqIJmq8/bPke1
         8PJA2xD8kwPuXHaxu493dZuePkxpYJ44YcHUwNJ8hNys7N2A7i7vg4lvvPsihjID02E9
         cgjQJ5fgreg1hJukfGPmhktpFlxp5xA2CjNlm1WbgucTYdfNagJPqOd0JFTnmzQtyRRb
         jERA==
X-Gm-Message-State: AOUpUlGy+6pjgBaCYaWLOyQcA3cKZZwSA7hiYr9w0n0rS5nN2xUmOiU2
        fh3AbNgCpoYtkXCmPz1ga5aqAWq9
X-Google-Smtp-Source: AA+uWPzID1OUNzGhgfjY2nngWwFwQSPr+uYxwb9kMDE043y2rfm1lA711Ri10XLlZ9YNyVudypZO3Q==
X-Received: by 2002:aa7:c592:: with SMTP id g18-v6mr3413198edq.214.1533736309805;
        Wed, 08 Aug 2018 06:51:49 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id u3-v6sm1619420edo.44.2018.08.08.06.51.46
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 06:51:49 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 11/11] builtin rebase: support `git rebase <upstream> <switch-to>`
Date:   Wed,  8 Aug 2018 19:33:30 +0545
Message-Id: <20180808134830.19949-12-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808134830.19949-1-predatoramigo@gmail.com>
References: <20180808134830.19949-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808134830.19949-12-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit adds support for `switch-to` which is used to switch to the
target branch if needed. The equivalent codes found in shell script
`git-legacy-rebase.sh` is converted to builtin `rebase.c`.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 48 ++++++++++++++++++++++++++++++++++++++++++++----
 1 file changed, 44 insertions(+), 4 deletions(-)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 63634210c0..b2ddfa8dbf 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -79,6 +79,7 @@ struct rebase_options {
 	struct commit *onto;
 	const char *onto_name;
 	const char *revisions;
+	const char *switch_to;
 	int root;
 	struct commit *restrict_revision;
 	int dont_finish_rebase;
@@ -186,6 +187,8 @@ static int run_specific_rebase(struct rebase_options *opts)
 		opts->flags & REBASE_DIFFSTAT ? "t" : "");
 	add_var(&script_snippet, "force_rebase",
 		opts->flags & REBASE_FORCE ? "t" : "");
+	if (opts->switch_to)
+		add_var(&script_snippet, "switch_to", opts->switch_to);
 
 	switch (opts->type) {
 	case REBASE_AM:
@@ -564,9 +567,23 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	 * orig_head -- commit object name of tip of the branch before rebasing
 	 * head_name -- refs/heads/<that-branch> or NULL (detached HEAD)
 	 */
-	if (argc > 0)
-		 die("TODO: handle switch_to");
-	else {
+	if (argc == 1) {
+		/* Is it "rebase other branchname" or "rebase other commit"? */
+		branch_name = argv[0];
+		options.switch_to = argv[0];
+
+		/* Is it a local branch? */
+		strbuf_reset(&buf);
+		strbuf_addf(&buf, "refs/heads/%s", branch_name);
+		if (!read_ref(buf.buf, &options.orig_head))
+			options.head_name = xstrdup(buf.buf);
+		/* If not is it a valid ref (branch or commit)? */
+		else if (!get_oid(branch_name, &options.orig_head))
+			options.head_name = NULL;
+		else
+			die(_("fatal: no such branch/commit '%s'"),
+			    branch_name);
+	} else if (argc == 0) {
 		/* Do not need to switch branches, we are already on it. */
 		options.head_name =
 			xstrdup_or_null(resolve_ref_unsafe("HEAD", 0, NULL,
@@ -585,7 +602,8 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		}
 		if (get_oid("HEAD", &options.orig_head))
 			die(_("Could not resolve HEAD to a revision"));
-	}
+	} else
+		BUG("unexpected number of arguments left to parse");
 
 	if (read_index(the_repository->index) < 0)
 		die(_("could not read index"));
@@ -612,6 +630,28 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		int flag;
 
 		if (!(options.flags & REBASE_FORCE)) {
+			/* Lazily switch to the target branch if needed... */
+			if (options.switch_to) {
+				struct object_id oid;
+
+				if (get_oid(options.switch_to, &oid) < 0) {
+					ret = !!error(_("could not parse '%s'"),
+						      options.switch_to);
+					goto cleanup;
+				}
+
+				strbuf_reset(&buf);
+				strbuf_addf(&buf, "rebase: checkout %s",
+					    options.switch_to);
+				if (reset_head(&oid, "checkout",
+					       options.head_name, 0) < 0) {
+					ret = !!error(_("could not switch to "
+							"%s"),
+						      options.switch_to);
+					goto cleanup;
+				}
+			}
+
 			if (!(options.flags & REBASE_NO_QUIET))
 				; /* be quiet */
 			else if (!strcmp(branch_name, "HEAD") &&
-- 
2.18.0


