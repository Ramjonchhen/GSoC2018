From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.1 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 47CEF208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 15:08:41 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727542AbeHHR2o (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 13:28:44 -0400
Received: from mail-ed1-f65.google.com ([209.85.208.65]:39550 "EHLO
        mail-ed1-f65.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727295AbeHHR2o (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 13:28:44 -0400
Received: by mail-ed1-f65.google.com with SMTP id h4-v6so1425106edi.6
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 08:08:38 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=dDE/smkhR9lCraIjOQQofSERBhDmVR4+rSnTl0Bb3FY=;
        b=Cl7dZtq+mvdHzQ+602Fi7EbrNBRbbULr7A9s1kGy7khyne2/5DxQMLVvgTJRyFeNvp
         HsUp15neBbW9lI0ngwqSKNqeWj3rtZnrNiew92ZXtq6T+c+CrayCuIoCBOFS2JwUdTmN
         /wcAyld2/hWj0dxECLeKE03V5bFwbmMK1/wXlsiriWw8LVGQgE2RUzKChwQyODkUeD2T
         Jct6MlQ9d6AVI5ruCX4dwLHN+1WFBWMoaNqwGr1VsnuhZ8AzAATI8KdesTYErQRvw1kO
         +BgvbSuMxeHQx8n7YA+YqvoGAmnfU7uxzcfnP4K00QToTFXs6njtll9v0gyykrykNTeD
         ew0Q==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=dDE/smkhR9lCraIjOQQofSERBhDmVR4+rSnTl0Bb3FY=;
        b=Axr9C1K0NWjGGBAsvtApv2AXjbHzjesiS8xVXkXealke67hY4+WGddjDFAjOUJyHKH
         HATfNIwBSZGo0rS85TcZZkxzJSdo5hFbCZiDybavgC3tILFuxd3N4DodNBdxHKjBTQCd
         WF3VhHqQPpYraQN1EERgPP8fIPvH+1L8itKjOCDg3p/AXmCGsCzSc26fvlXxZC0cVqMa
         tVwZsIjOMGcVvfuLXv9nS0slEGoO0c4VSDmU2j003Trok4e7L2BFeEtnrYlchPaa9jQr
         wgyPPx/tY3fYABNttfIrolX9K7x5kt2R8YJx+jqxpST6cUBHbHoOhUY+P64lpzcLaxWB
         5H4A==
X-Gm-Message-State: AOUpUlF72iw2txmt5SgTznEXWg1JxHBNl+bt5/q+hE219oblEDcihYVM
        ieS9WmoiqtFEDmSGgjIKBx0vEudt
X-Google-Smtp-Source: AA+uWPzr5wz+plbvTf71epWEPt0FFLRhQ8A0B6yUAJjm/k+SAkOxlwTd/85+xSOyw4pTqHagSI/Q2g==
X-Received: by 2002:aa7:c306:: with SMTP id l6-v6mr3627520edq.53.1533740917518;
        Wed, 08 Aug 2018 08:08:37 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id w1-v6sm6771259eda.63.2018.08.08.08.08.34
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 08:08:36 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 1/7] builtin rebase: support --continue
Date:   Wed,  8 Aug 2018 20:51:16 +0545
Message-Id: <20180808150622.9614-2-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808150622.9614-1-predatoramigo@gmail.com>
References: <20180808150622.9614-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808150622.9614-2-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit adds the option `--continue` which is used to resume
rebase after merge conflicts. The code tries to stay as close to
the equivalent shell scripts found in `git-legacy-rebase.sh` as
possible.

When continuing a rebase, the state variables are read from state_dir.
Some of the state variables are not actually stored there, such as
`upstream`. The shell script version simply does not set them, but for
consistency, we unset them in the builtin version.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 115 +++++++++++++++++++++++++++++++++++++++++++++--
 strbuf.c         |   9 ++++
 strbuf.h         |   3 ++
 3 files changed, 123 insertions(+), 4 deletions(-)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index b2ddfa8dbf..10da4c978b 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -91,6 +91,7 @@ struct rebase_options {
 		REBASE_INTERACTIVE_EXPLICIT = 1<<4,
 	} flags;
 	struct strbuf git_am_opt;
+	const char *action;
 };
 
 static int is_interactive(struct rebase_options *opts)
@@ -115,6 +116,62 @@ static const char *state_dir_path(const char *filename, struct rebase_options *o
 	return path.buf;
 }
 
+/* Read one file, then strip line endings */
+static int read_one(const char *path, struct strbuf *buf)
+{
+	if (strbuf_read_file(buf, path, 0) < 0)
+		return error_errno(_("could not read '%s'"), path);
+	strbuf_trim_trailing_newline(buf);
+	return 0;
+}
+
+/* Initialize the rebase options from the state directory. */
+static int read_basic_state(struct rebase_options *opts)
+{
+	struct strbuf head_name = STRBUF_INIT;
+	struct strbuf buf = STRBUF_INIT;
+	struct object_id oid;
+
+	if (read_one(state_dir_path("head-name", opts), &head_name) ||
+	    read_one(state_dir_path("onto", opts), &buf))
+		return -1;
+	opts->head_name = starts_with(head_name.buf, "refs/") ?
+		xstrdup(head_name.buf) : NULL;
+	strbuf_release(&head_name);
+	if (get_oid(buf.buf, &oid))
+		return error(_("could not get 'onto': '%s'"), buf.buf);
+	opts->onto = lookup_commit_or_die(&oid, buf.buf);
+
+	/*
+	 * We always write to orig-head, but interactive rebase used to write to
+	 * head. Fall back to reading from head to cover for the case that the
+	 * user upgraded git with an ongoing interactive rebase.
+	 */
+	strbuf_reset(&buf);
+	if (file_exists(state_dir_path("orig-head", opts))) {
+		if (read_one(state_dir_path("orig-head", opts), &buf))
+			return -1;
+	} else if (read_one(state_dir_path("head", opts), &buf))
+		return -1;
+	if (get_oid(buf.buf, &opts->orig_head))
+		return error(_("invalid orig-head: '%s'"), buf.buf);
+
+	strbuf_reset(&buf);
+	if (read_one(state_dir_path("quiet", opts), &buf))
+		return -1;
+	if (buf.len)
+		opts->flags &= ~REBASE_NO_QUIET;
+	else
+		opts->flags |= REBASE_NO_QUIET;
+
+	if (file_exists(state_dir_path("verbose", opts)))
+		opts->flags |= REBASE_VERBOSE;
+
+	strbuf_release(&buf);
+
+	return 0;
+}
+
 static int finish_rebase(struct rebase_options *opts)
 {
 	struct strbuf dir = STRBUF_INIT;
@@ -168,12 +225,13 @@ static int run_specific_rebase(struct rebase_options *opts)
 	add_var(&script_snippet, "state_dir", opts->state_dir);
 
 	add_var(&script_snippet, "upstream_name", opts->upstream_name);
-	add_var(&script_snippet, "upstream",
-				 oid_to_hex(&opts->upstream->object.oid));
+	add_var(&script_snippet, "upstream", opts->upstream ?
+		oid_to_hex(&opts->upstream->object.oid) : NULL);
 	add_var(&script_snippet, "head_name",
 		opts->head_name ? opts->head_name : "detached HEAD");
 	add_var(&script_snippet, "orig_head", oid_to_hex(&opts->orig_head));
-	add_var(&script_snippet, "onto", oid_to_hex(&opts->onto->object.oid));
+	add_var(&script_snippet, "onto", opts->onto ?
+		oid_to_hex(&opts->onto->object.oid) : NULL);
 	add_var(&script_snippet, "onto_name", opts->onto_name);
 	add_var(&script_snippet, "revisions", opts->revisions);
 	add_var(&script_snippet, "restrict_revision", opts->restrict_revision ?
@@ -189,6 +247,7 @@ static int run_specific_rebase(struct rebase_options *opts)
 		opts->flags & REBASE_FORCE ? "t" : "");
 	if (opts->switch_to)
 		add_var(&script_snippet, "switch_to", opts->switch_to);
+	add_var(&script_snippet, "action", opts->action ? opts->action : "");
 
 	switch (opts->type) {
 	case REBASE_AM:
@@ -400,12 +459,16 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		.git_am_opt = STRBUF_INIT,
 	};
 	const char *branch_name;
-	int ret, flags, in_progress = 0;
+	int ret, flags, total_argc, in_progress = 0;
 	int ok_to_skip_pre_rebase = 0;
 	struct strbuf msg = STRBUF_INIT;
 	struct strbuf revisions = STRBUF_INIT;
 	struct strbuf buf = STRBUF_INIT;
 	struct object_id merge_base;
+	enum {
+		NO_ACTION,
+		ACTION_CONTINUE,
+	} action = NO_ACTION;
 	struct option builtin_rebase_options[] = {
 		OPT_STRING(0, "onto", &options.onto_name,
 			   N_("revision"),
@@ -427,6 +490,8 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		OPT_BIT(0, "no-ff", &options.flags,
 			N_("cherry-pick all commits, even if unchanged"),
 			REBASE_FORCE),
+		OPT_CMDMODE(0, "continue", &action, N_("continue"),
+			    ACTION_CONTINUE),
 		OPT_END(),
 	};
 
@@ -480,14 +545,55 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	if (options.type != REBASE_UNSPECIFIED)
 		in_progress = 1;
 
+	total_argc = argc;
 	argc = parse_options(argc, argv, prefix,
 			     builtin_rebase_options,
 			     builtin_rebase_usage, 0);
 
+	if (action != NO_ACTION && total_argc != 2) {
+		usage_with_options(builtin_rebase_usage,
+				   builtin_rebase_options);
+	}
+
 	if (argc > 2)
 		usage_with_options(builtin_rebase_usage,
 				   builtin_rebase_options);
 
+	switch (action) {
+	case ACTION_CONTINUE: {
+		struct object_id head;
+		struct lock_file lock_file = LOCK_INIT;
+		int fd;
+
+		options.action = "continue";
+
+		/* Sanity check */
+		if (get_oid("HEAD", &head))
+			die(_("Cannot read HEAD"));
+
+		fd = hold_locked_index(&lock_file, 0);
+		if (read_index(the_repository->index) < 0)
+			die(_("could not read index"));
+		refresh_index(the_repository->index, REFRESH_QUIET, NULL, NULL,
+			      NULL);
+		if (0 <= fd)
+			update_index_if_able(the_repository->index,
+					     &lock_file);
+		rollback_lock_file(&lock_file);
+
+		if (has_unstaged_changes(1)) {
+			puts(_("You must edit all merge conflicts and then\n"
+			       "mark them as resolved using git add"));
+			exit(1);
+		}
+		if (read_basic_state(&options))
+			exit(1);
+		goto run_rebase;
+	}
+	default:
+		die("TODO");
+	}
+
 	/* Make sure no rebase is in progress */
 	if (in_progress) {
 		const char *last_slash = strrchr(options.state_dir, '/');
@@ -719,6 +825,7 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 
 	options.revisions = revisions.buf;
 
+run_rebase:
 	ret = !!run_specific_rebase(&options);
 
 cleanup:
diff --git a/strbuf.c b/strbuf.c
index 030556111d..fdc0ffbafb 100644
--- a/strbuf.c
+++ b/strbuf.c
@@ -120,6 +120,15 @@ void strbuf_trim_trailing_dir_sep(struct strbuf *sb)
 	sb->buf[sb->len] = '\0';
 }
 
+void strbuf_trim_trailing_newline(struct strbuf *sb)
+{
+	if (sb->len > 0 && sb->buf[sb->len - 1] == '\n') {
+		if (--sb->len > 0 && sb->buf[sb->len - 1] == '\r')
+			--sb->len;
+		sb->buf[sb->len] = '\0';
+	}
+}
+
 void strbuf_ltrim(struct strbuf *sb)
 {
 	char *b = sb->buf;
diff --git a/strbuf.h b/strbuf.h
index 60a35aef16..b7aea8a966 100644
--- a/strbuf.h
+++ b/strbuf.h
@@ -190,6 +190,9 @@ extern void strbuf_ltrim(struct strbuf *);
 /* Strip trailing directory separators */
 extern void strbuf_trim_trailing_dir_sep(struct strbuf *);
 
+/* Strip trailing LF or CR/LF */
+extern void strbuf_trim_trailing_newline(struct strbuf *sb);
+
 /**
  * Replace the contents of the strbuf with a reencoded form.  Returns -1
  * on error, 0 on success.
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.1 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 49DF9208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 15:08:44 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727552AbeHHR2r (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 13:28:47 -0400
Received: from mail-ed1-f49.google.com ([209.85.208.49]:33986 "EHLO
        mail-ed1-f49.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727295AbeHHR2r (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 13:28:47 -0400
Received: by mail-ed1-f49.google.com with SMTP id h1-v6so1436829eds.1
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 08:08:42 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=3SjqkVGDcjXMwiwTRmN1EiI1j8c+J3Mn9b+nGKu6AK0=;
        b=mPfffA3AjVYVHl2FBo3cHHziucQn5zFslFbId6+HlfLB6qwjKJYi1TTfKCoGLHevBK
         lH9zlPoV/5ApXRgj2IgL6FHKChnvABWeldrdAqFw4SXmIf3DIvwQuMbzIMWVo/cFH5R/
         dbO1o1w/52NCPitLtqJJjAIxQV0aGu1JqBT9TL9F7hBDNyM3aRrpGVubyE9WmCihmrqb
         fUgO5fmb0Ob+LVoZ+RuPTearYQx5Jrjc+zigREOLFGooQpc526JkdjD/mpoJDrEVFfl8
         +Yr4jdg5dl3wvDv18QeV0rJ9D8J584ipvotXcZIAHsCWC65m2MGpQx5pREjNRWeBMgyJ
         HuSw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=3SjqkVGDcjXMwiwTRmN1EiI1j8c+J3Mn9b+nGKu6AK0=;
        b=kQDq1H65H/XVE7pOJkZH2oDUCzrvbxvoFJb0gHt1BgMuJhRoOSmOJTm0qC9TYi439L
         pG5Xnx8rGaGNHGhiGagjqLesZC+arMI079Y3p2I7cxeVR0gOlfrdywAmhWuNC9egZgto
         PwMtsbSEc/M/vL50Fzfwqi0rac91aD+DvXuNmKqGh48ut16r7s4RNcI6XcPKuttGn96p
         8wR9viRwLIrn3qoCoOyFrD2DbBmgczGL1Qd/driM6MabFcMHDtafyPgP3AY93pOyHmdf
         xRHS4yfXTQDkH737OAT6FVguoENkFovaIr9Sl7Uem8y0IiFNRFIEKavrc4U+1ksT5RFv
         24dQ==
X-Gm-Message-State: AOUpUlHfJbp9bIERQC8BGHzUP2Q9TI+YxGgGuq1Zt+qZeQ548r+IRPHu
        3SogEq7YpIE/4pcDLJRo9NAhcadR
X-Google-Smtp-Source: AA+uWPzTdq6kNnEqKIhbNpUkJntG0qMNLUnagx80Df4EyD/zIeW3C3xTDcfFohGmByFDHNU0DSAnSw==
X-Received: by 2002:a50:bec2:: with SMTP id e2-v6mr3793633edk.283.1533740921219;
        Wed, 08 Aug 2018 08:08:41 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id w1-v6sm6771259eda.63.2018.08.08.08.08.37
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 08:08:40 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 2/7] builtin rebase: support --skip
Date:   Wed,  8 Aug 2018 20:51:17 +0545
Message-Id: <20180808150622.9614-3-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808150622.9614-1-predatoramigo@gmail.com>
References: <20180808150622.9614-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808150622.9614-3-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit adds the option `--skip` which is used to restart
rebase after skipping the current patch.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 10da4c978b..7a903838b1 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -21,6 +21,7 @@
 #include "diff.h"
 #include "wt-status.h"
 #include "revision.h"
+#include "rerere.h"
 
 static char const * const builtin_rebase_usage[] = {
 	N_("git rebase [-i] [options] [--exec <cmd>] [--onto <newbase>] "
@@ -468,6 +469,7 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 	enum {
 		NO_ACTION,
 		ACTION_CONTINUE,
+		ACTION_SKIP,
 	} action = NO_ACTION;
 	struct option builtin_rebase_options[] = {
 		OPT_STRING(0, "onto", &options.onto_name,
@@ -492,6 +494,8 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			REBASE_FORCE),
 		OPT_CMDMODE(0, "continue", &action, N_("continue"),
 			    ACTION_CONTINUE),
+		OPT_CMDMODE(0, "skip", &action,
+			    N_("skip current patch and continue"), ACTION_SKIP),
 		OPT_END(),
 	};
 
@@ -590,6 +594,20 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			exit(1);
 		goto run_rebase;
 	}
+	case ACTION_SKIP: {
+		struct string_list merge_rr = STRING_LIST_INIT_DUP;
+
+		options.action = "skip";
+
+		rerere_clear(&merge_rr);
+		string_list_clear(&merge_rr, 1);
+
+		if (reset_head(NULL, "reset", NULL, 0) < 0)
+			die(_("could not discard worktree changes"));
+		if (read_basic_state(&options))
+			exit(1);
+		goto run_rebase;
+	}
 	default:
 		die("TODO");
 	}
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.1 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id CE9A6208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 15:08:47 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727583AbeHHR2u (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 13:28:50 -0400
Received: from mail-ed1-f66.google.com ([209.85.208.66]:36740 "EHLO
        mail-ed1-f66.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727554AbeHHR2u (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 13:28:50 -0400
Received: by mail-ed1-f66.google.com with SMTP id k15-v6so1433347edr.3
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 08:08:45 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=4T86mXkX0KHxNfq3CPNLUlZGo049qn6BVZViWOpQPLk=;
        b=UsPbeItcU9XH1VnGxvFm2ZJZzt9k936KRepbD2eINAopRtfXZ7AGOZb+uC6L4rU2zR
         rSJT9IrTs7QlYg4EKTsIkgbKiKJ+pJt0h8jZugF0Wf199q5OPV79qsvNxDLEyekCIa4N
         Tp1Id7xs2Yr6HwA8KQnIbznk4GTIpzOr8mkMiCD3YcQduvj9ZYyqy8SLwsaL6zR9stiU
         K3S6Cbj31p9EqetZiAktlYVVKPMKeYkdik5wVNdKqiaWX1meDk0OheJuMEmcTK57nLUj
         hry0DfVa+nndtPKn00z9enLtobUNWaIyzDnzOCReiGSm91pHb5Mi0VgHIRdrY5KamfSW
         lT3A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=4T86mXkX0KHxNfq3CPNLUlZGo049qn6BVZViWOpQPLk=;
        b=WfI9ACkdJJ31owqoOhEM74jOVRdBZw646xOAhPc6ZqI0gjsKA9cLIFFwcsRJgSJtVP
         ZTryF9RDeP6LYM7I7bBNIymAK7n7hoijRyUsIYc0YciwyOgI1qDRtatXjEHxnj4jCmuo
         De/7g+aMLld0g1nB679HeKGRPTQHEPfUBVln8cKHlmp2JPkjF9pCk63goXo/fmuXWM0y
         vThqIhJAI6yx8QLvobwi+P4e86wzIEBsPy3K1sTcxHwUkaD9FR4GSVoiKUt4yFXF2q2I
         e/tipbcQQZJOFljcwHqcXzueTP9KWkeEG6V1KskM4Zj/rmJHbCEz2zfS4/NAgYIhCbrZ
         o0Dw==
X-Gm-Message-State: AOUpUlHVMy5gK9oBB7GN+J5npjt5vOsbUi5Lrl0IDV6O4IJdon4ScRKi
        bvX4cKxWPpcKhwY7N5V+VxxF94VQ
X-Google-Smtp-Source: AA+uWPxEUQFtzHGqXIFxbr3b94jURU2cyOgRqa6KjCm1RlbnDAJh5nCvgg9YcY3CzVl57cCDwhUP5w==
X-Received: by 2002:a50:80e6:: with SMTP id 93-v6mr3718100edb.252.1533740924883;
        Wed, 08 Aug 2018 08:08:44 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id w1-v6sm6771259eda.63.2018.08.08.08.08.41
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 08:08:44 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 3/7] builtin rebase: support --abort
Date:   Wed,  8 Aug 2018 20:51:18 +0545
Message-Id: <20180808150622.9614-4-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808150622.9614-1-predatoramigo@gmail.com>
References: <20180808150622.9614-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808150622.9614-4-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit teaches the builtin rebase the "abort" action, which a user
can call to roll back a rebase that is in progress.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 20 ++++++++++++++++++++
 1 file changed, 20 insertions(+)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 7a903838b1..8e94f6cc85 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -470,6 +470,7 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		NO_ACTION,
 		ACTION_CONTINUE,
 		ACTION_SKIP,
+		ACTION_ABORT,
 	} action = NO_ACTION;
 	struct option builtin_rebase_options[] = {
 		OPT_STRING(0, "onto", &options.onto_name,
@@ -496,6 +497,9 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			    ACTION_CONTINUE),
 		OPT_CMDMODE(0, "skip", &action,
 			    N_("skip current patch and continue"), ACTION_SKIP),
+		OPT_CMDMODE(0, "abort", &action,
+			    N_("abort and check out the original branch"),
+			    ACTION_ABORT),
 		OPT_END(),
 	};
 
@@ -608,6 +612,22 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			exit(1);
 		goto run_rebase;
 	}
+	case ACTION_ABORT: {
+		struct string_list merge_rr = STRING_LIST_INIT_DUP;
+		options.action = "abort";
+
+		rerere_clear(&merge_rr);
+		string_list_clear(&merge_rr, 1);
+
+		if (read_basic_state(&options))
+			exit(1);
+		if (reset_head(&options.orig_head, "reset",
+			       options.head_name, 0) < 0)
+			die(_("could not move back to %s"),
+			    oid_to_hex(&options.orig_head));
+		ret = finish_rebase(&options);
+		goto cleanup;
+	}
 	default:
 		die("TODO");
 	}
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.1 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 6C98D208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 15:08:51 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727598AbeHHR2y (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 13:28:54 -0400
Received: from mail-ed1-f66.google.com ([209.85.208.66]:39566 "EHLO
        mail-ed1-f66.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727554AbeHHR2y (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 13:28:54 -0400
Received: by mail-ed1-f66.google.com with SMTP id h4-v6so1425402edi.6
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 08:08:49 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=n8rZ+CEFju32GaZ8xRq9yXtgpQZTEx3H465fASddhZw=;
        b=Aj0nIrHlZL/Yf0fH0lHKmgZxuJKCJ2cj+/j2SniKFG7RxsYdwzSJs4MV5SrRosonT8
         7jtaZkney8CwaFK+DY3vyS692up85Ae6XQ4hT66oWKw3ZU7NnzM4cAWyx7pNNsRROK6H
         XeUCAKdVDxa617mejyyIJFTSiKClOBWu9tpJsFfcEQV1dhUajN2wIhDCjFwZu2R2vEtq
         TojL7V/GHsttpKO0UVxT1ekHfXj3SGVOoyufB+diO4yUkNByzDgq1XVRr/cD2Lq3IA4I
         IYVlugjiU7yxGdW5IXM4q92Eow31LVr+TunzOj1FQl9qDtE3lUVO+Eu8/HIwaT9eGczQ
         MALw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=n8rZ+CEFju32GaZ8xRq9yXtgpQZTEx3H465fASddhZw=;
        b=o44Ldytp5MzAsPYfPpYcfdU66VmYjj0VLznNkHNsORCo6141bJqd9DSRJKVYVizL1r
         dSsk0XjOstFpld4dXZdX8whVOjIHOdSZ6ATx0ULw2s2lw26aIUJPzGuyx9pFi8Osn2pJ
         xiToKpbPveidSr0xGFMu0w9j2ySMC4RQFcOGd3qUJRpmlUcVELOw1bjLYDQGx5kIdmN+
         NZCIHpZ/s59neDXCGo3zQYHzkSkwazAmm4OtR2vMvhgA+41LpFv6UUkHecG9ZFHygH+c
         cvfMm8ZtGBtwqWL3+WcO3tZAz3GSgHwGz6UgOK9ZwKrNIxeopg2/1cwkmh4SnJy5bz2N
         aVKg==
X-Gm-Message-State: AOUpUlGBydCFAKm/Chxhr/Id+dxkSZr3NCmMVmpziqs15cd173J822nQ
        evx3uOlupOJcdNJJnUVIObTliMmc
X-Google-Smtp-Source: AA+uWPwLpQyG/oxgQfG4EmuvAA6az35zItGGDzTlqkZo6r1ljzXmIzJX77ieUUKxIUN9SrqIz/b5XQ==
X-Received: by 2002:aa7:d40a:: with SMTP id z10-v6mr3736242edq.203.1533740928530;
        Wed, 08 Aug 2018 08:08:48 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id w1-v6sm6771259eda.63.2018.08.08.08.08.45
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 08:08:47 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 4/7] builtin rebase: support --quit
Date:   Wed,  8 Aug 2018 20:51:19 +0545
Message-Id: <20180808150622.9614-5-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808150622.9614-1-predatoramigo@gmail.com>
References: <20180808150622.9614-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808150622.9614-5-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

With this patch, the builtin rebase handles the `--quit` action which
can be used to abort a rebase without rolling back any changes performed
during the rebase (this is useful when a user forgot that they were in
the middle of a rebase and continued working normally).

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 8e94f6cc85..0d805480a1 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -471,6 +471,7 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		ACTION_CONTINUE,
 		ACTION_SKIP,
 		ACTION_ABORT,
+		ACTION_QUIT,
 	} action = NO_ACTION;
 	struct option builtin_rebase_options[] = {
 		OPT_STRING(0, "onto", &options.onto_name,
@@ -500,6 +501,8 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		OPT_CMDMODE(0, "abort", &action,
 			    N_("abort and check out the original branch"),
 			    ACTION_ABORT),
+		OPT_CMDMODE(0, "quit", &action,
+			    N_("abort but keep HEAD where it is"), ACTION_QUIT),
 		OPT_END(),
 	};
 
@@ -628,6 +631,14 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		ret = finish_rebase(&options);
 		goto cleanup;
 	}
+	case ACTION_QUIT: {
+		strbuf_reset(&buf);
+		strbuf_addstr(&buf, options.state_dir);
+		ret = !!remove_dir_recursively(&buf, 0);
+		if (ret)
+			die(_("could not remove '%s'"), options.state_dir);
+		goto cleanup;
+	}
 	default:
 		die("TODO");
 	}
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.1 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id D8985208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 15:08:55 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727669AbeHHR26 (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 13:28:58 -0400
Received: from mail-ed1-f66.google.com ([209.85.208.66]:46695 "EHLO
        mail-ed1-f66.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727657AbeHHR26 (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 13:28:58 -0400
Received: by mail-ed1-f66.google.com with SMTP id o8-v6so1403585edt.13
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 08:08:53 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=L3O8EYNisoqg/mkSItYPDc9MH/YnQ7QUP/SjqDsacnY=;
        b=P5d2T9p0jG+UOK6yKZUmsEjzAjIuRwbVsj5QGfeSm6ti1wakZafaCncsyHK7UbhCZY
         IY7L9XGRFdd+sYIFqY+YXC/NNTQAjuiSMZR/nlmJUQwKcADu17bcSAvIWx6ibQHjlKk2
         KnIUQwRhgT1hnJKjMdECjkpcrFBui8m8DiTvXyYmaytXRtl1hg0Ep88rGr/TUSvuhZqC
         s3ZPGxcgie9myjcR+lwtYndEObUcYhyuWXmhaQLGDE9EfEbNJKwFLw0h1KJhh7ZgOHXQ
         b41XRC00HCGLtu31HWc0Gy6H+NXEEkKDDn7WwA6m2bB4E5rg/SiZ6wiugfOg7E8tutsz
         15nw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=L3O8EYNisoqg/mkSItYPDc9MH/YnQ7QUP/SjqDsacnY=;
        b=Aw/kGka0xWpTm0B3DUnFGOHkLW38NwbL72335+LP9zevPImb4s6eMR4hZk12fSqreR
         S9M1I3UvlU5Ql6sW0CbxspcoFA4teYjuUxair0UK8vTdMU97h4bzaFzwKEseI+d+8sqf
         vP+RYVMO34Ue9vTjVjndzB9rOSoxJ1syC4U1L1Kkiak3Bbx0ktfpYo+i47qyOWJVarQR
         EAgKT6RepJLgQ0F8MBbkcYblFJeshhAZPJl0v9c4QbwQrGWysMxh41B0xnNaZ88SN8Yw
         mqOhrI0zExvlZRdE29gDswZ1azXfffvRMUjY3juZH+IS84eQojW98illenXY86o/a4wP
         qQ4Q==
X-Gm-Message-State: AOUpUlEDXtmsB5SlM60+PWC/BZAXfiku/WZ1mk4Ckml3Oswdpn/j5Lp4
        9z5iU8bixY8VXK1AxUD7D5XWOUWW
X-Google-Smtp-Source: AA+uWPxStBPY8T1EmIrBvHNjsVtq/3WqzSJJqIuD8DjW5KOeiz6sE9k0gh7UFC6RzHGgnyiWbIUR3Q==
X-Received: by 2002:a50:b206:: with SMTP id o6-v6mr3695167edd.160.1533740932387;
        Wed, 08 Aug 2018 08:08:52 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id w1-v6sm6771259eda.63.2018.08.08.08.08.48
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 08:08:51 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 5/7] builtin rebase: support --edit-todo and --show-current-patch
Date:   Wed,  8 Aug 2018 20:51:20 +0545
Message-Id: <20180808150622.9614-6-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808150622.9614-1-predatoramigo@gmail.com>
References: <20180808150622.9614-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808150622.9614-6-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

While these sub-commands are very different in spirit, their
implementation is almost identical, so we convert them in one go.

And since those are the last sub-commands that needed to be converted,
now we can also turn that `default:` case into a bug (because we should
now handle all the actions).

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 23 ++++++++++++++++++++++-
 1 file changed, 22 insertions(+), 1 deletion(-)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 0d805480a1..e3dd2f511e 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -472,6 +472,8 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		ACTION_SKIP,
 		ACTION_ABORT,
 		ACTION_QUIT,
+		ACTION_EDIT_TODO,
+		ACTION_SHOW_CURRENT_PATCH,
 	} action = NO_ACTION;
 	struct option builtin_rebase_options[] = {
 		OPT_STRING(0, "onto", &options.onto_name,
@@ -503,6 +505,11 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			    ACTION_ABORT),
 		OPT_CMDMODE(0, "quit", &action,
 			    N_("abort but keep HEAD where it is"), ACTION_QUIT),
+		OPT_CMDMODE(0, "edit-todo", &action, N_("edit the todo list "
+			    "during an interactive rebase"), ACTION_EDIT_TODO),
+		OPT_CMDMODE(0, "show-current-patch", &action,
+			    N_("show the patch file being applied or merged"),
+			    ACTION_SHOW_CURRENT_PATCH),
 		OPT_END(),
 	};
 
@@ -570,6 +577,10 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		usage_with_options(builtin_rebase_usage,
 				   builtin_rebase_options);
 
+	if (action == ACTION_EDIT_TODO && !is_interactive(&options))
+		die(_("The --edit-todo action can only be used during "
+		      "interactive rebase."));
+
 	switch (action) {
 	case ACTION_CONTINUE: {
 		struct object_id head;
@@ -639,8 +650,18 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 			die(_("could not remove '%s'"), options.state_dir);
 		goto cleanup;
 	}
+	case ACTION_EDIT_TODO:
+		options.action = "edit-todo";
+		options.dont_finish_rebase = 1;
+		goto run_rebase;
+	case ACTION_SHOW_CURRENT_PATCH:
+		options.action = "show-current-patch";
+		options.dont_finish_rebase = 1;
+		goto run_rebase;
+	case NO_ACTION:
+		break;
 	default:
-		die("TODO");
+		BUG("action: %d", action);
 	}
 
 	/* Make sure no rebase is in progress */
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.1 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id A8F82208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 15:08:58 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727671AbeHHR3B (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 13:29:01 -0400
Received: from mail-ed1-f66.google.com ([209.85.208.66]:37425 "EHLO
        mail-ed1-f66.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727448AbeHHR3B (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 13:29:01 -0400
Received: by mail-ed1-f66.google.com with SMTP id b10-v6so1436058eds.4
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 08:08:56 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=2nDuFhYq6xBuXc5AJJ7xL/44Ppj7a46lSUOWHESOLE0=;
        b=QHIXOEV7WiZSrFxT5myYlPEMTjv056RSNJ8x17/jtFQwCYsJTNWreWBxZJ994kjb/U
         dMFMNcfiXILaUBB+QNAyUUFxK0uoDd+pe7LpnzE1uXCg//r5NLvaqlYkxAQ25o4AUL/5
         FdlxoyQecN4GtJdS341rNFa3EemxjgYGwxW298YNJwUUJsrYsIzYUsiYm8viiW9QDYv/
         3RgEjKfwrxxM1G+gP+FuEgDOxiI7KfS/TsrSfDKCuL4arKsaxnJJT2vPVPGVGCxNThUL
         XmEB7vfM8XXqnY7DAj0uD2OTdj59NcmTVR0J1cT/LMP0QHeCvuqQ60DSuRZdpGoy1nDG
         3lFg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=2nDuFhYq6xBuXc5AJJ7xL/44Ppj7a46lSUOWHESOLE0=;
        b=VQpNY9tjCe7qru3sShwcrJ2mO4zeeWy9qzzBQCzLy2diiMGfkuc2E6OKLjA2rV2y0L
         Eo5FUqwJqUllQJ97uaFOI8nIQ2tUOc5n6AVDX3gx+CIac+pyi90uHrUB2361954C2rPz
         65H20ok5wxVtwMKotrfcskGP0mngwDrI9cYKE0n+Nh2z3/mY6ZXplAuceyxO9RJhxL12
         oR3a6M8igUqWZbt8L2NOejUv0IVyBaMDp/kA7VpUde0yFSNiTpneDvXizPCDdLWtnuo6
         Dfj5u4TkhpGl8RP3UlbFTAN7TmKNtsh1mWoLS6BxnsOO+H/+COPytWtLoaeSVMQt+8XR
         JHhQ==
X-Gm-Message-State: AOUpUlENR5hqo9HtSdRWeDsd7dLWVlUd+hjiaYwXHJJTMEZKzLowAzar
        TZL9cfJm+2MOkjw4pWa3lOoDkey9
X-Google-Smtp-Source: AA+uWPzBZtzJhziFsguGhTaffvRgtcICLvGglfaaonfyfNkltwqRu80E+Y8aXv+at8wxvTrUAoKXIA==
X-Received: by 2002:a50:dd4b:: with SMTP id u11-v6mr3841743edk.298.1533740936000;
        Wed, 08 Aug 2018 08:08:56 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id w1-v6sm6771259eda.63.2018.08.08.08.08.52
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 08:08:55 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 6/7] builtin rebase: actions require a rebase in progress
Date:   Wed,  8 Aug 2018 20:51:21 +0545
Message-Id: <20180808150622.9614-7-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808150622.9614-1-predatoramigo@gmail.com>
References: <20180808150622.9614-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808150622.9614-7-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit prevents actions (such as --continue, --skip) from running
when there is no rebase in progress.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index e3dd2f511e..1344e071f3 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -577,6 +577,9 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 		usage_with_options(builtin_rebase_usage,
 				   builtin_rebase_options);
 
+	if (action != NO_ACTION && !in_progress)
+		die(_("No rebase in progress?"));
+
 	if (action == ACTION_EDIT_TODO && !is_interactive(&options))
 		die(_("The --edit-todo action can only be used during "
 		      "interactive rebase."));
-- 
2.18.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-4.1 required=3.0 tests=AWL,BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,
	HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI
	shortcircuit=no autolearn=ham autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id D8A20208EB
	for <e@80x24.org>; Wed,  8 Aug 2018 15:09:02 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727681AbeHHR3G (ORCPT <rfc822;e@80x24.org>);
        Wed, 8 Aug 2018 13:29:06 -0400
Received: from mail-ed1-f43.google.com ([209.85.208.43]:43730 "EHLO
        mail-ed1-f43.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727295AbeHHR3F (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 8 Aug 2018 13:29:05 -0400
Received: by mail-ed1-f43.google.com with SMTP id j21-v6so1415843edp.10
        for <git@vger.kernel.org>; Wed, 08 Aug 2018 08:09:00 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:in-reply-to:references;
        bh=ERtrR3FOcdzqr+kW6+6mCYL0y7/y++TrppA7COP93h4=;
        b=YpU155wkHHj5hX8ksMByyzk6AMqFIx8N6DOTBouhk69xPYeF/MlE6zx05ERcvrcE6o
         cnlERpQ4ZrnmhgbPmRD4WD45TBLsCfVctEdaRhU8mD929PUQ3m3C/7Ep6eOzWPjty7Qc
         mE3Ke9TzMY5DyO3KBxP3G8dR1+H/dHxK1uGaFJJRGMngEfqnsOzebnvmhPa9eHAVt7IC
         VA29xYV+bUlVa78qe97Dv+BkBi2CUxrQ21ioDT8DAmqWpm30uptXnWZf6IW8AbhQcEWd
         GzUf5BjOKP0bi3y0fO2PqibuFUi0p2pP5XnyoN28kSWoy9BmK6XwFPtAgLDCJbrGafqK
         d9SQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references;
        bh=ERtrR3FOcdzqr+kW6+6mCYL0y7/y++TrppA7COP93h4=;
        b=Ox9hrcl5EqJXEnDsXgXPH/wq+U1/QLqLXGC9QAmglzeq640sSZa557iXTG5L0+j7ik
         1Va0QWxJmgiNyU9SQA7NTJecARqwVcG+QQhZ216+Q42KL0pTXErtfwnc3J+F2s70yS7K
         1VpXWFpqtRLh9plDTxSSj3om3v2N/SIosfGkv6EYvN5+dguL4zrH3D8BSHrXkfV8TBCj
         /jkt1GUkGh5/Oq1amFRvZexsbsRfUZ2/DGBK76BH8cqe33Hnzdc9/RunZR53c87PB+T/
         AIC5TEbGiCkMTLtoPBiWW+NvF9Ek7fHumaI+60k1oWgR5pqmJm3sY9fw+9vp/OeYJoVt
         aZgg==
X-Gm-Message-State: AOUpUlFicV6ZkVdMnGEBpu3XwAaAwwxRm6hXEP9RC039zZPLet726hI6
        2nhvWba7jIKzIYme2yhqnB4HS/8i
X-Google-Smtp-Source: AA+uWPwyw9aUA3qCol8W2pP96B35IauNHbre8RSLIE8//DQnx6o8I8fqkeeMNkWOLqql62GnplxGPQ==
X-Received: by 2002:aa7:d40a:: with SMTP id z10-v6mr3737313edq.203.1533740939663;
        Wed, 08 Aug 2018 08:08:59 -0700 (PDT)
Received: from localhost.localdomain ([27.34.16.181])
        by smtp.gmail.com with ESMTPSA id w1-v6sm6771259eda.63.2018.08.08.08.08.56
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 08 Aug 2018 08:08:58 -0700 (PDT)
From:   Pratik Karki <predatoramigo@gmail.com>
To:     git@vger.kernel.org
Cc:     christian.couder@gmail.com, Johannes.Schindelin@gmx.de,
        sbeller@google.com, alban.gruin@gmail.com, gitster@pobox.com,
        Pratik Karki <predatoramigo@gmail.com>
Subject: [PATCH 7/7] builtin rebase: stop if `git am` is in progress
Date:   Wed,  8 Aug 2018 20:51:22 +0545
Message-Id: <20180808150622.9614-8-predatoramigo@gmail.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20180808150622.9614-1-predatoramigo@gmail.com>
References: <20180808150622.9614-1-predatoramigo@gmail.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <https://public-inbox.org/git/20180808150622.9614-8-predatoramigo@gmail.com/>
List-Archive: <https://public-inbox.org/git/>
List-Post: <mailto:git@vger.kernel.org>

This commit checks for the file `applying` used by `git am` in
`rebase-apply/` and if the file is present it means `git am` is in
progress so it errors out.

Signed-off-by: Pratik Karki <predatoramigo@gmail.com>
---
 builtin/rebase.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/builtin/rebase.c b/builtin/rebase.c
index 1344e071f3..75c4ac66e0 100644
--- a/builtin/rebase.c
+++ b/builtin/rebase.c
@@ -539,6 +539,11 @@ int cmd_rebase(int argc, const char **argv, const char *prefix)
 
 	git_config(rebase_config, &options);
 
+	strbuf_reset(&buf);
+	strbuf_addf(&buf, "%s/applying", apply_dir());
+	if(file_exists(buf.buf))
+		die(_("It looks like 'git am' is in progress. Cannot rebase."));
+
 	if (is_directory(apply_dir())) {
 		options.type = REBASE_AM;
 		options.state_dir = apply_dir();
-- 
2.18.0


